<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SpacesAI</title>
  <link rel="icon" type="image/png" sizes="64x64" href="/static/icons/favicon-64.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/apple-touch-icon.png" />
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body class="saas">
  <header class="topbar topbar--app">
    <div class="topbar-brand" aria-label="SpacesAI space selector">
      <button id="topbarHomeBtn" class="topbar-home" type="button" aria-label="Go to home">SpacesAI</button>
      <select id="topbarSpaceSelect" aria-label="Choose space"></select>
    </div>
    <div class="spacer"></div>
    <button id="themeBtn" class="ghost" title="Toggle dark mode">üåì</button>
  </header>

  <main class="app-shell app-shell--ios">
    <section class="app-screen active" id="screenSearch" data-screen="search">
      <div class="screen-hero" aria-label="Search">
        <button class="logo" id="logoHomeBtn" type="button" aria-label="SPACES home">
          <span class="g g-blue">S</span>
          <span class="g g-red">P</span>
          <span class="g g-yellow">A</span>
          <span class="g g-blue">C</span>
          <span class="g g-green">E</span>
          <span class="g g-red">S</span>
        </button>
        <p class="screen-subtitle">Search your spaces</p>
      </div>
      <section id="loggedOutLanding" class="landing" hidden>
        <div class="landing-card">
          <span class="landing-kicker">SpacesAI Workspace</span>
          <h1>Ask questions, organize knowledge, and explore your documents.</h1>
          <p>SpacesAI brings NotebookLM-style research to your private library so you can chat, summarize, and manage content in one place.</p>
          <div class="landing-actions">
            <button id="landingCtaBtn" class="primary">Try SpacesAI</button>
            <button id="landingLearnBtn" class="ghost" type="button">See how it works</button>
          </div>
        </div>
      </section>
      <div id="appPanel" class="app-panel" hidden>
        <section id="unifiedSearchPanel" class="search-panel" role="region" aria-label="Search workspace">
          <div class="search-tabs" role="tablist" aria-label="Search mode">
            <button id="searchModeText" class="search-tab active" role="tab" aria-selected="true">Text Search</button>
            <button id="searchModeImage" class="search-tab" role="tab" aria-selected="false">Image Search</button>
          </div>
          <div class="searchbar">
            <input id="searchInput" class="search-input" type="text" placeholder="Search documents‚Ä¶" autocomplete="off" />
            <button id="drBtn" class="dr-icon" title="Deep Research">üî¨</button>
          </div>
          <div class="search-actions-row">
            <button id="searchBtn" class="primary">Search</button>
            <button id="settingsBtn" class="ghost" title="Search settings" aria-expanded="false">‚öôÔ∏è</button>
          </div>

          <div id="settingsPanel" class="settings" hidden>
            <div id="textSettings" class="settings-pane">
              <div class="row wrap">
                <div class="row no-grow">
                  <label for="mode">Mode</label>
                  <select id="mode">
                    <option value="hybrid">Hybrid</option>
                    <option value="semantic">Semantic</option>
                    <option value="fulltext">Full-text</option>
                    <option value="rag" selected>RAG</option>
                  </select>
                </div>
                <div class="row no-grow">
                  <label for="provider" class="leftpad">LLM Provider</label>
                  <select id="provider">
                    <option value="">Default</option>
                    <option value="oci">OCI</option>
                    <option value="openai">OpenAI</option>
                    <option value="bedrock">Bedrock</option>
                    <option value="ollama">Ollama</option>
                  </select>
                </div>
                <div class="row no-grow">
                  <label for="topk" class="leftpad">Top K</label>
                  <input id="topk" type="number" value="25" min="1" max="50" />
                </div>
                <div class="row no-grow">
                  <label for="autoSearch" class="leftpad">Auto search</label>
                  <input id="autoSearch" type="checkbox" />
                  <label for="debounceMs" class="leftpad">Debounce (ms)</label>
                  <input id="debounceMs" type="number" value="400" min="100" max="2000" />
                </div>
              </div>
              <div class="row wrap">
                <div class="row no-grow">
                  <strong>Search backend:</strong>&nbsp;<span id="cfgBackend">-</span>
                </div>
                <div class="row no-grow">
                  <label for="cfgTopK" class="leftpad">Default Top K</label>
                  <input id="cfgTopK" type="number" min="1" max="1000" placeholder="25" />
                </div>
                <div class="row no-grow" id="cfgPgvectorRow" hidden>
                  <label for="cfgProbes" class="leftpad">pgvector probes</label>
                  <input id="cfgProbes" type="number" min="1" max="10000" placeholder="env default" />
                </div>
                <div class="row no-grow" id="cfgNumCandRow" hidden>
                  <label for="cfgNumCand" class="leftpad">OS num_candidates</label>
                  <input id="cfgNumCand" type="number" min="1" max="1000000" placeholder="heuristic default" />
                </div>
                <div class="row no-grow">
                  <button id="loadCfgBtn" class="ghost">Refresh config</button>
                  <button id="saveCfgBtn" class="ghost">Save</button>
                </div>
              </div>
              <div class="row wrap">
                <label>Space</label>
                <span class="muted">Manage spaces in the Account tab.</span>
              </div>
            </div>

            <div id="imageSettings" class="settings-pane" hidden>
              <div class="row wrap">
                <div class="row no-grow">
                  <label class="block" for="imageTags">Tag filters (comma separated)</label>
                  <input id="imageTags" type="text" placeholder="policy, architecture" />
                </div>
                <div class="row no-grow">
                  <label class="block" for="imageTopK">Top K</label>
                  <input id="imageTopK" type="number" min="1" max="100" value="12" />
                </div>
                <div class="row no-grow">
                  <label class="block" for="imageThumbSize">Preview size</label>
                  <select id="imageThumbSize">
                    <option value="small" selected>Small</option>
                    <option value="medium">Medium</option>
                    <option value="large">Large</option>
                  </select>
                </div>
              </div>
              <div class="row wrap">
                <div class="row no-grow">
                  <label class="block" for="imageFile">Reference image (optional)</label>
                  <input id="imageFile" type="file" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp,image/bmp" />
                </div>
                <div class="row no-grow">
                  <button id="imageClearBtn" class="ghost" type="button">Clear image inputs</button>
                </div>
              </div>
              <div class="muted">Tip: combine descriptive text, tags, or a reference upload to improve similarity results.</div>
            </div>
          </div>
        </section>



        <div class="row middle">
          <div class="loader" id="searchLoading" hidden>
            <div class="spinner"></div>
            <span>Searching‚Ä¶</span>
          </div>
        </div>

        <div class="row" id="answerRow" hidden>
          <label>Answer / Context <span id="llmBadge" class="badge" style="display:none"></span></label>
          <pre id="answer" class="panel"></pre>
          <label id="refsLabel" style="display:none">References</label>
          <div id="refs" class="results" style="margin-top:8px; display:none"></div>
        </div>
        <div class="row" id="resultsRow" hidden>
          <label>Results</label>
          <div id="results" class="results"></div>
        </div>

        <div id="imageResultsSection" class="card card--wide" hidden>
          <div class="row middle" id="imageSearchLoading" hidden>
            <div class="spinner"></div>
            <span>Searching images‚Ä¶</span>
          </div>
          <div id="imageResultsEmpty" class="muted" hidden>No images yet. Try uploading visual assets or drag & drop a reference image.</div>
          <div id="imageResultsGrid" class="image-results-grid"></div>
        </div>
      </div>
    </section>

    <section class="app-screen" id="screenLibrary" data-screen="library">
      <div class="screen-header">
        <button id="kbHeaderToggle" class="kb-header-toggle" type="button" aria-expanded="false">
          <div>
            <p class="screen-kicker">Library</p>
            <h2>Your Knowledge Base</h2>
          </div>
          <span class="caret" aria-hidden="true">‚ñ∏</span>
        </button>
      </div>
      <div class="screen-locked" id="kbLocked" hidden>
        <strong>Sign in to access your library.</strong>
        <p class="muted">Once logged in, you can review and manage your documents here.</p>
      </div>
      <section id="kbSection" class="card card--wide card-soft" hidden>
        <div class="kb-toolbar">
          <p class="muted">Review and manage your stored documents.</p>
          <div class="kb-toolbar-actions">
            <div class="kb-toolbar-row">
              <div class="kb-view-toggle" role="group" aria-label="View toggle">
                <button id="kbViewListBtn" class="ghost active" type="button">List</button>
                <button id="kbViewGridBtn" class="ghost" type="button">Grid</button>
              </div>
              <button id="kbRefreshBtn" class="primary">Refresh</button>
              <button id="kbDeleteSelectedBtn" class="ghost" title="Delete selected">Delete selected</button>
            </div>
            <div class="kb-toolbar-row">
              <button id="kbSortBtn" class="ghost" title="Toggle sort order">Latest first</button>
              <button id="kbAlphaSortBtn" class="ghost" title="Toggle alphabetical sort">A‚ÄìZ</button>
            </div>
          </div>
        </div>
        <div id="kbBody" class="kb-body">
          <div class="kb-select-row">
            <label><input type="checkbox" id="kbSelectAll" /> Select all</label>
          </div>
          <div class="row">
            <div id="kbList" class="results"></div>
          </div>
          <div class="kb-toolbar-row kb-pagination" id="kbPagination" hidden>
            <div class="kb-page-info" id="kbPageInfo">0 documents</div>
            <div class="kb-page-list" id="kbPageList" aria-label="KB pages"></div>
          </div>
        </div>
      </section>
    </section>

    <section class="app-screen" id="screenUpload" data-screen="upload">
      <div class="screen-header">
        <button id="uploadHeaderToggle" class="kb-header-toggle" type="button" aria-expanded="false">
          <div>
            <p class="screen-kicker">Upload</p>
            <h2>Add content to your space</h2>
          </div>
          <span class="caret" aria-hidden="true">‚ñ∏</span>
        </button>
      </div>
      <div class="screen-locked" id="uploadLocked" hidden>
        <strong>Sign in to access your library.</strong>
        <p class="muted">Once logged in, you can review and manage your documents here.</p>
      </div>
      <section id="uploadSection" class="card card--wide card-soft" hidden>
        <div class="upload-header">
          <div>
            <p class="screen-kicker">Upload</p>
            <h3>Upload to your space</h3>
            <p class="muted">Drop files or browse to add new knowledge.</p>
          </div>
          <button id="clearUploadBtn" class="ghost" title="Clear uploads"><span class="refresh-icon">‚Üª</span></button>
        </div>
        <div class="upload-actions">
          <div class="upload-picker">
            <label class="upload-picker-label" for="files">
              <span>Browse files</span>
            </label>
            <input id="files" type="file" multiple accept=".pdf,.txt,.csv,.md,.json,.html,.htm,.docx,.pptx,.xlsx,.png,.jpg,.jpeg,.tif,.tiff,.bmp,.gif" />
            <span id="fileSelectionText" class="muted">No files selected.</span>
          </div>
          <div class="upload-submit">
            <button id="uploadBtn" class="primary">Upload</button>
            <div class="loader" id="uploadLoading" hidden>
              <div class="spinner small"></div>
              <span>Processing‚Ä¶</span>
            </div>
            <span id="uploadEmbeddingStatus" class="badge badge-soft" hidden></span>
          </div>
        </div>
        <div class="row">
          <div id="dropzone" class="dropzone upload-dropzone">
            <div class="dz-inner">
              <div class="dz-header">Drag & drop files</div>
              <div class="dz-desc">
                <strong>Documents:</strong> PDF, DOCX, PPTX, XLSX, TXT, HTML, CSV, MD, JSON
                <br />
                <strong>Images:</strong> PNG, JPG, JPEG, TIFF, BMP, GIF
              </div>
              <div class="dz-status" id="dzStatus">Drop files here or use the file chooser above</div>
              <div class="dz-meta" id="uploadStorageInfo"></div>
            </div>
          </div>
        </div>
        <div class="row" id="uploadListRow" hidden>
          <div id="uploadList" class="progress-list"></div>
        </div>
        <div class="row" id="uploadStatusRow" hidden>
          <pre id="uploadStatus" class="panel"></pre>
        </div>
      </section>
    </section>

    <section class="app-screen" id="screenResearch" data-screen="research">
      <div class="screen-header">
        <button id="researchHeaderToggle" class="kb-header-toggle" type="button" aria-expanded="false">
          <div>
            <p class="screen-kicker">Research</p>
            <h2>Deep research workspace</h2>
          </div>
          <span class="caret" aria-hidden="true">‚ñ∏</span>
        </button>
      </div>
      <div id="researchSection" class="card card--wide research-card" hidden>
        <h3>Deep Research</h3>
        <p class="muted">Launch a guided research session to synthesize answers from your spaces and the web.</p>
        <button id="researchOpenBtn" class="primary">Open Deep Research</button>
      </div>
      <div class="screen-locked" id="researchLocked" hidden>
        <strong>Sign in to access your library.</strong>
        <p class="muted">Once logged in, you can review and manage your documents here.</p>
      </div>
    </section>

    <section class="app-screen" id="screenAccount" data-screen="account">
      <div class="screen-header" id="accountHeader">
        <button id="accountHeaderToggle" class="kb-header-toggle" type="button" aria-expanded="false">
          <div>
            <p class="screen-kicker">Account</p>
            <h2>Manage your profile</h2>
          </div>
          <span class="caret" aria-hidden="true">‚ñ∏</span>
        </button>
      </div>
      <div id="authPanel" class="auth" hidden>
        <div class="row cols">
          <div class="auth-card" id="loginCard">
            <h3>Sign in</h3>
            <label class="block">Email</label>
            <input id="loginEmail" type="email" placeholder="you@example.com" />
            <label class="block">Password</label>
            <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            <button id="loginBtn" class="primary">Login</button>
            <p class="small">New here? <a href="#" id="showRegisterLink">Create account</a></p>
          </div>
          <div class="auth-card" id="registerCard" hidden>
            <h3>Create account</h3>
            <label class="block">Email</label>
            <input id="regEmail" type="email" placeholder="you@example.com" />
            <label class="block">Password</label>
            <input id="regPassword" type="password" placeholder="At least 8 characters" />
            <button id="registerBtn">Register</button>
            <p class="small"><a href="#" id="cancelRegisterLink">Back to sign in</a></p>
          </div>
        </div>
      </div>
      <div id="accountPanel" class="card card--wide card-soft" hidden>
        <div class="row account-summary">
          <div>
            <strong>Signed in</strong>
            <p id="userEmail" class="user-email"></p>
          </div>
          <button id="logoutBtn" class="ghost" title="Logout">Logout</button>
        </div>
        <div class="row wrap account-actions">
          <div class="account-segment">
            <span class="segment-label">Space</span>
            <div class="segment-control">
              <select id="spacesSelect"></select>
              <button id="setDefaultSpaceBtn" class="ghost">Set default</button>
            </div>
          </div>
          <div class="account-segment">
            <span class="segment-label">New space</span>
            <div class="segment-control">
              <input id="newSpaceName" placeholder="Create new space‚Ä¶" />
              <button id="createSpaceBtn">Create</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <nav class="bottom-nav" aria-label="Primary">
    <button class="bottom-nav__item active" type="button" data-screen-target="search">
      <span class="bottom-nav__icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" role="presentation"><circle cx="11" cy="11" r="7"></circle><line x1="16" y1="16" x2="21" y2="21"></line></svg>
      </span>
      <span>Search</span>
    </button>
    <button class="bottom-nav__item" type="button" data-screen-target="library">
      <span class="bottom-nav__icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" role="presentation"><rect x="4" y="5" width="6" height="14" rx="2"></rect><rect x="10" y="5" width="6" height="14" rx="2"></rect><rect x="16" y="5" width="4" height="14" rx="2"></rect></svg>
      </span>
      <span>Library</span>
    </button>
    <button class="bottom-nav__item" type="button" data-screen-target="upload">
      <span class="bottom-nav__icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" role="presentation"><path d="M12 16V6"></path><path d="M8 10l4-4 4 4"></path><rect x="5" y="16" width="14" height="4" rx="2"></rect></svg>
      </span>
      <span>Upload</span>
    </button>
    <button class="bottom-nav__item" type="button" data-screen-target="research" id="bottomNavResearch">
      <span class="bottom-nav__icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" role="presentation"><path d="M9 3h6"></path><path d="M10 3v5l-5 9a4 4 0 0 0 3.5 6h7a4 4 0 0 0 3.5-6l-5-9V3"></path><path d="M8 15h8"></path></svg>
      </span>
      <span>Research</span>
    </button>
    <button class="bottom-nav__item" type="button" data-screen-target="account" id="bottomNavAccount">
      <span class="bottom-nav__icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" role="presentation"><circle cx="12" cy="9" r="4"></circle><path d="M4 21c1.6-4 5-6 8-6s6.4 2 8 6"></path></svg>
      </span>
      <span>Account</span>
    </button>
  </nav>

  <div id="toast" class="toast" hidden></div>
  <div id="imagePreviewBackdrop" class="modal-backdrop" hidden></div>
  <div id="imagePreviewModal" class="image-preview-modal" hidden role="dialog" aria-modal="true" aria-label="Image preview">
    <button id="imagePreviewClose" class="ghost" type="button" aria-label="Close image preview">‚úï</button>
    <img id="imagePreviewImg" alt="" />
    <div id="imagePreviewCaption" class="muted"></div>
  </div>

  <div id="drBackdrop" class="dr-backdrop" hidden></div>
  <div id="drModal" class="dr-modal" hidden aria-modal="true" role="dialog">
    <div class="dr-header">
      <div class="dr-title">
        <div class="dr-title-main">
          <strong>Deep Research</strong>
        </div>
        <div class="dr-title-controls">
          <input id="drActiveTitle" type="text" placeholder="Session name" aria-label="Conversation title" />
          <button id="drSessionRefresh" class="ghost dr-session-refresh" title="Start a new session">‚Üª</button>
          <button id="drRenameBtn" class="ghost dr-rename" title="Rename session">Rename</button>
        </div>
      </div>
      <div class="dr-header-actions">
        <label class="ios-toggle" title="Always include web search">
          <input id="drForceWeb" type="checkbox" />
          <span class="ios-toggle-slider"></span>
          <span class="ios-toggle-label">Web</span>
        </label>
        <div class="dr-menu">
          <button id="drMenuBtn" class="ghost pill" title="Actions" aria-haspopup="true" aria-expanded="false">‚ãØ</button>
          <div id="drMenu" class="dr-menu-panel" role="menu" hidden>
            <button id="drMenuSessions" class="ghost" role="menuitem">Sessions</button>
            <button id="drMenuNotebook" class="ghost" role="menuitem">Notebook</button>
            <button id="drMenuReset" class="ghost" role="menuitem">New session</button>
          </div>
        </div>
        <button id="drClose" class="ghost" title="Close">‚úï</button>
      </div>
    </div>
    <div class="dr-main">
      <div class="dr-main-hero" id="drHero">
        <div>
          <p class="pill-badge pill-source">Research mode</p>
          <h3>Ask or paste references to investigate deeper</h3>
          <p id="drHeroStatus" class="muted">Sessions auto-save per space. URLs can be included directly inside your question.</p>
          <div id="drSourceTicker" class="dr-source-ticker" hidden>
            <span class="dr-source-dot"></span>
            <span id="drSourceTickerText" class="dr-source-text"></span>
          </div>
        </div>
      </div>
      <div id="drEmptyState" class="dr-timeline-empty">
        <h3>No conversation yet</h3>
        <p>Type a question to create your knowledge timeline.</p>
        <button id="drNewSession" class="ghost">Start fresh</button>
      </div>
      <div id="drTimeline" class="dr-chat" aria-live="polite"></div>
      <div class="dr-composer">
        <textarea id="drMessage" rows="3" placeholder="Ask a question, add bullet points, or paste URLs inline‚Ä¶"></textarea>
        <div class="dr-composer-actions">
          <div class="dr-composer-left">
            <button id="drSessionsToggleSecondary" class="ghost text-link" type="button">Sessions</button>
            <button id="drNotebookToggleSecondary" class="ghost text-link" type="button">Notebook</button>
          </div>
          <div class="dr-composer-right">
            <span id="drIngestStatus" class="dr-ingest-status" hidden>
              <span class="dr-ingest-spinner" aria-hidden="true"></span>
              <span class="dr-ingest-text">Ingesting URLs‚Ä¶</span>
            </span>
            <span id="drWebStatus" class="muted"></span>
            <button id="drSend" class="primary">Send</button>
          </div>
        </div>
      </div>
    </div>
    <aside id="drSessionsDrawer" class="dr-drawer" data-drawer="sessions" aria-label="Deep research sessions">
      <div class="dr-drawer-head">
        <div>
          <strong>Sessions</strong>
          <p class="muted" id="drSessionHint">Resume or branch your research</p>
        </div>
        <button class="ghost" data-dr-drawer-close>&times;</button>
      </div>
      <div class="dr-drawer-body">
        <button id="drNewSessionDrawer" class="ghost fullwidth">Ôºã New session</button>
        <div class="dr-convo-list" id="drConvoList">
          <div class="muted">Loading sessions‚Ä¶</div>
        </div>
      </div>
    </aside>
    <aside id="drNotebookDrawer" class="dr-drawer" data-drawer="notebook" aria-label="Deep research notebook">
      <div class="dr-drawer-head">
        <strong>Notebook Pins</strong>
        <div class="drawer-head-actions">
          <button id="drNotebookRefresh" class="ghost" title="Refresh notebook">‚Üª</button>
          <button class="ghost" data-dr-drawer-close>&times;</button>
        </div>
      </div>
      <div class="dr-drawer-body">
        <form id="drNotebookForm" class="dr-notebook-form">
          <input id="drNotebookTitle" type="text" placeholder="Note title" />
          <textarea id="drNotebookContent" rows="3" placeholder="What insight do you want to pin?"></textarea>
          <div class="dr-notebook-actions">
            <button type="submit" class="primary">Add note</button>
            <button type="button" id="drNotebookClear" class="ghost">Clear</button>
          </div>
        </form>
        <div id="drNotebookEmpty" class="muted">No notebook entries yet.</div>
        <div id="drNotebookList" class="dr-notebook-list"></div>
      </div>
    </aside>
    <div id="drDrawerBackdrop" class="dr-drawer-backdrop" hidden></div>
  </div>
  <div id="drFollowupBackdrop" class="dr-followup-backdrop" hidden></div>
  <div id="drFollowupModal" class="dr-followup-modal" hidden role="dialog" aria-modal="true" aria-label="Answer follow-up">
    <div class="dr-followup-head">
      <strong>Answer follow-up</strong>
      <button id="drFollowupClose" class="ghost" title="Close">‚úï</button>
    </div>
    <div class="dr-followup-body">
      <p class="muted">Follow-up question</p>
      <div id="drFollowupQuestion" class="dr-followup-question"></div>
      <label for="drFollowupAnswer">Your response</label>
      <textarea id="drFollowupAnswer" rows="4" placeholder="Type your response‚Ä¶"></textarea>
    </div>
    <div class="dr-followup-actions">
      <button id="drFollowupCancel" class="ghost">Cancel</button>
      <button id="drFollowupSend" class="primary">Send response</button>
    </div>
  </div>

  <script>
    // Theme toggle
    (function(){
      const btn = document.getElementById('themeBtn');
      const curr = localStorage.getItem('theme');
      if (curr === 'dark') document.body.classList.add('dark');
      btn.addEventListener('click', () => {
        document.body.classList.toggle('dark');
        localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
      });
    })();

    // Helpers
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.hidden = false;
      setTimeout(() => { t.hidden = true; t.textContent = ''; }, 3000);
    }
    function escapeHtml(s) {
      return (s || '')
        .replace(/&/g, '&')
        .replace(/</g, '<')
        .replace(/>/g, '>')
        .replace(/\"/g, '"')
        .replace(/'/g, '&#039;');
    }
    function highlight(text, query) {
      if (!query) return escapeHtml(text);
      try {
        const esc = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const re = new RegExp(esc, 'ig');
        return escapeHtml(text).replace(re, m => `<mark>${escapeHtml(m)}</mark>`);
      } catch {
        return escapeHtml(text);
      }
    }
    function basename(path) {
      if (!path) return '';
      const idx = path.lastIndexOf('/');
      return idx >= 0 ? path.slice(idx + 1) : path;
    }
    function formatDocTitle(doc) {
      if (!doc) return '';
      return doc.title || doc.file_name || basename(doc.source_path) || `Document ${doc.id ?? ''}`.trim();
    }
    function formatDateLabel(value) {
      if (!value) return '';
      const dt = new Date(value);
      if (Number.isNaN(dt.getTime())) return '';
      return dt.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }
    function normalizeImageTags(tags = []) {
      if (!Array.isArray(tags)) return [];
      return tags
        .map(tag => String(tag || '').trim())
        .filter(tag => {
          if (!tag) return false;
          const letters = tag.replace(/[^a-zA-Z]/g, '');
          const digits = tag.replace(/[^0-9]/g, '');
          if (digits.length > 0 && letters.length === 0) return false;
          if (digits.length > letters.length * 2 && letters.length < 2) return false;
          return true;
        });
    }
    function renderLLMText(s) {
      // Minimal markdown-ish renderer: code fences, lists, paragraphs
      const text = s || '';
      // Split code blocks
      const parts = text.split(/```/g);
      let html = '';
      for (let i = 0; i < parts.length; i++) {
        if (i % 2 === 1) {
          // code block
          const rawCode = parts[i] || '';
          let codeText = rawCode.replace(/^\r?\n/, '');
          const codeLines = codeText.split(/\r?\n/);
          if (codeLines.length && /^[a-z0-9_-]+$/i.test(codeLines[0].trim())) {
            codeLines.shift();
          }
          codeText = codeLines.join('\n');
          html += `<pre class="code"><code>${escapeHtml(codeText)}</code></pre>`;
        } else {
          // normal text -> handle lists and paragraphs
          const block = parts[i];
          const lines = block.split(/\r?\n/);
          let inUl = false, inOl = false;
          const out = [];
          const flushList = () => {
            if (inUl) { out.push('</ul>'); inUl = false; }
            if (inOl) { out.push('</ol>'); inOl = false; }
          };
          for (const raw of lines) {
            const ln = raw.trimEnd();
            if (/^\s*[-*]\s+/.test(ln)) {
              if (!inUl) { flushList(); out.push('<ul>'); inUl = true; }
              out.push(`<li>${escapeHtml(ln.replace(/^\s*[-*]\s+/, ''))}</li>`);
            } else if (/^\s*\d+[\.)\-:]\s+/.test(ln)) {
              if (!inOl) { flushList(); out.push('<ol>'); inOl = true; }
              out.push(`<li>${escapeHtml(ln.replace(/^\s*\d+[\.)\-:]\s+/, ''))}</li>`);
            } else if (ln.trim() === '') {
              if (inUl || inOl) {
                continue;
              }
              flushList();
              out.push('<p></p>');
            } else {
              flushList();
              out.push(`<p>${escapeHtml(ln)}</p>`);
            }
          }
          flushList();
          html += out.join('');
        }
      }
      // Compact empty paragraphs
      html = html.replace(/(<p><\/p>\s*)+/g, '<p></p>');
      return html;
    }
    async function api(path, opts={}) {
      const isForm = opts.body instanceof FormData;
      const headers = opts.headers || (isForm ? undefined : { 'Content-Type': 'application/json' });
      const res = await fetch(path, {
        method: opts.method || 'GET',
        headers,
        body: opts.body ? (isForm ? opts.body : JSON.stringify(opts.body)) : undefined,
        signal: opts.signal,
      });
      if (!res.ok) throw new Error(await res.text());
      const ct = res.headers.get('content-type') || '';
      return ct.includes('application/json') ? await res.json() : await res.text();
    }

    async function checkImageEmbeddingStatus(docId) {
      if (!docId) return null;
      try {
        const diag = await api(`/api/image-search/diagnostics?doc_id=${encodeURIComponent(docId)}`);
        return diag || null;
      } catch (e) {
        return null;
      }
    }

    // App state
    let state = {
      user: null,
      spaces: [],
      spaceId: null,
      imageSearchAbort: null,
      storageBackend: null,
    };

    let kbOrder = 'desc';
    let kbAlphaOrder = null;
    let kbViewMode = 'list';
    let kbExpanded = false;
    let kbPage = 1;
    const kbPageSize = 25;
    let uploadExpanded = false;
    let accountExpanded = false;
    let researchExpanded = false;

    function setTopbarSpaceDisabled(disabled) {
      const topbarSelect = document.getElementById('topbarSpaceSelect');
      if (topbarSelect) topbarSelect.disabled = disabled;
    }

    function setTopbarSpaceVisible(visible) {
      const topbarSelect = document.getElementById('topbarSpaceSelect');
      if (topbarSelect) topbarSelect.hidden = !visible;
    }

    function setLoggedInUI() {
      const auth = document.getElementById('authPanel');
      const accountPanel = document.getElementById('accountPanel');
      const app = document.getElementById('appPanel');
      const landing = document.getElementById('loggedOutLanding');
      const up = document.getElementById('uploadSection');
      const kb = document.getElementById('kbSection');
      const emailEl = document.getElementById('userEmail');
      const kbLocked = document.getElementById('kbLocked');
      const kbSection = document.getElementById('kbSection');
      const uploadLocked = document.getElementById('uploadLocked');
      const researchLocked = document.getElementById('researchLocked');
      const researchSection = document.getElementById('researchSection');
      const accountHeader = document.getElementById('accountHeader');
      const accountHeaderToggle = document.getElementById('accountHeaderToggle');
      if (state.user) {
        if (auth) auth.hidden = true;
        if (accountPanel) accountPanel.hidden = !accountExpanded;
        if (app) app.hidden = false;
        if (landing) landing.hidden = true;
        if (up) up.hidden = !uploadExpanded;
        if (kb) kb.hidden = false;
        if (kbSection) kbSection.hidden = !kbExpanded;
        if (kbLocked) kbLocked.hidden = true;
        if (uploadLocked) uploadLocked.hidden = !uploadExpanded;
        if (researchLocked) researchLocked.hidden = true;
        if (researchSection) researchSection.hidden = !researchExpanded;
        if (accountHeader) accountHeader.hidden = false;
        if (accountHeaderToggle) accountHeaderToggle.setAttribute('aria-expanded', String(accountExpanded));
        if (emailEl) emailEl.textContent = state.user.email;
        setTopbarSpaceVisible(true);
      } else {
        if (auth) auth.hidden = false;
        if (accountPanel) accountPanel.hidden = true;
        if (app) app.hidden = true;
        if (landing) landing.hidden = false;
        if (up) up.hidden = true;
        if (kb) kb.hidden = true;
        if (kbSection) kbSection.hidden = true;
        if (kbLocked) kbLocked.hidden = false;
        if (uploadLocked) uploadLocked.hidden = false;
        if (researchLocked) researchLocked.hidden = false;
        if (researchSection) researchSection.hidden = true;
        if (accountHeader) accountHeader.hidden = true;
        if (emailEl) emailEl.textContent = '';
        setTopbarSpaceVisible(false);
      }
    }

    function populateSpaces() {
      const sel = document.getElementById('spacesSelect');
      const topSel = document.getElementById('topbarSpaceSelect');
      sel.innerHTML = '';
      if (topSel) topSel.innerHTML = '';
      for (const s of state.spaces) {
        const opt = document.createElement('option');
        opt.value = String(s.id);
        opt.textContent = s.name + (s.is_default ? ' (default)' : '');
        sel.appendChild(opt);
        if (topSel) {
          const topOpt = document.createElement('option');
          topOpt.value = String(s.id);
          topOpt.textContent = s.name;
          topSel.appendChild(topOpt);
        }
      }
      if (state.spaceId) {
        sel.value = String(state.spaceId);
        if (topSel) topSel.value = String(state.spaceId);
      }
    }

    async function initUser() {
      try {
        const me = await api('/api/me');
        if (me && me.user) {
          state.user = me.user;
          state.spaces = me.spaces || [];
          const def = (state.spaces.find(s => s.is_default) || {}).id;
          state.spaceId = def || (state.spaces[0] ? state.spaces[0].id : null);
          populateSpaces();
          setTopbarSpaceDisabled(false);
        } else {
          state.user = null;
          state.spaces = [];
          state.spaceId = null;
          setTopbarSpaceDisabled(true);
        }
      } catch (e) {
        state.user = null;
        state.spaces = [];
        state.spaceId = null;
        setTopbarSpaceDisabled(true);
      }
      setLoggedInUI();
    }

    function setKbViewMode(nextMode) {
      const listBtn = document.getElementById('kbViewListBtn');
      const gridBtn = document.getElementById('kbViewGridBtn');
      const list = document.getElementById('kbList');
      kbViewMode = nextMode === 'grid' ? 'grid' : 'list';
      if (listBtn) listBtn.classList.toggle('active', kbViewMode === 'list');
      if (gridBtn) gridBtn.classList.toggle('active', kbViewMode === 'grid');
      if (list) list.classList.toggle('kb-grid', kbViewMode === 'grid');
    }

    function setKbExpanded(expanded) {
      kbExpanded = Boolean(expanded);
      const kbHeaderToggle = document.getElementById('kbHeaderToggle');
      const kbBody = document.getElementById('kbBody');
      const kbSection = document.getElementById('kbSection');
      if (kbHeaderToggle) kbHeaderToggle.setAttribute('aria-expanded', String(kbExpanded));
      if (kbBody) kbBody.hidden = !kbExpanded;
      if (kbSection) kbSection.hidden = !kbExpanded;
      if (kbHeaderToggle) kbHeaderToggle.classList.toggle('is-open', kbExpanded);
    }

    function setUploadExpanded(expanded) {
      uploadExpanded = Boolean(expanded);
      const headerToggle = document.getElementById('uploadHeaderToggle');
      const uploadSection = document.getElementById('uploadSection');
      const uploadLocked = document.getElementById('uploadLocked');
      if (headerToggle) headerToggle.setAttribute('aria-expanded', String(uploadExpanded));
      if (uploadSection) uploadSection.hidden = !uploadExpanded || !state.user;
      if (uploadLocked) uploadLocked.hidden = !state.user;
      if (headerToggle) headerToggle.classList.toggle('is-open', uploadExpanded);
    }

    function setAccountExpanded(expanded) {
      accountExpanded = Boolean(expanded);
      const headerToggle = document.getElementById('accountHeaderToggle');
      const auth = document.getElementById('authPanel');
      const accountPanel = document.getElementById('accountPanel');
      if (headerToggle) headerToggle.setAttribute('aria-expanded', String(accountExpanded));
      if (auth) auth.hidden = Boolean(state.user) ? true : !accountExpanded;
      if (accountPanel) accountPanel.hidden = !accountExpanded || !state.user;
      if (headerToggle) headerToggle.classList.toggle('is-open', accountExpanded);
    }

    function setResearchExpanded(expanded) {
      researchExpanded = Boolean(expanded);
      const headerToggle = document.getElementById('researchHeaderToggle');
      const researchSection = document.getElementById('researchSection');
      const researchLocked = document.getElementById('researchLocked');
      if (headerToggle) headerToggle.setAttribute('aria-expanded', String(researchExpanded));
      if (researchSection) researchSection.hidden = !researchExpanded || !state.user;
      if (researchLocked) researchLocked.hidden = Boolean(state.user);
      if (headerToggle) headerToggle.classList.toggle('is-open', researchExpanded);
    }

    // Auth handlers
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      try {
        const resp = await api('/api/login', { method: 'POST', body: { email, password } });
        state.user = resp.user; state.spaces = resp.spaces || [];
        const def = (state.spaces.find(s => s.is_default) || {}).id;
        state.spaceId = def || (state.spaces[0] ? state.spaces[0].id : null);
        populateSpaces();
        setLoggedInUI();
        if (document.querySelector('.app-screen.active')?.dataset.screen === 'account') {
          setActiveScreen('search');
        }
        await loadKB();
        showToast('Logged in');
      } catch (e) {
        let msg = 'Login failed';
        try { const js = JSON.parse(e.message || '{}'); if (js && js.error) msg = js.error; } catch {}
        showToast(msg);
      }
    });
    document.getElementById('registerBtn').addEventListener('click', async () => {
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;
      try {
        const resp = await api('/api/register', { method: 'POST', body: { email, password } });
        // For SaaS-like UX: redirect users back to sign in (do not auto-login)
        try { await api('/api/logout', { method: 'POST' }); } catch {}
        state = { user: null, spaces: [], spaceId: null };
        // Prefill login email for convenience
        const le = document.getElementById('loginEmail'); if (le) le.value = email;
        // Toggle back to login view
        const loginCard = document.querySelector('#authPanel #loginCard');
        const regCard = document.getElementById('registerCard');
        if (loginCard) loginCard.hidden = false;
        if (regCard) regCard.hidden = true;
        setLoggedInUI();
        showToast('Account created. Please sign in.');
      } catch (e) {
        let msg = 'Registration failed';
        try { const js = JSON.parse(e.message || '{}'); if (js && js.error) msg = js.error; } catch {}
        showToast(msg);
      }
    });
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try { await api('/api/logout', { method: 'POST' }); } catch {}
      state = { user: null, spaces: [], spaceId: null };
      setLoggedInUI();
      // Clear stored Deep Research conversations on logout
      try { Object.keys(localStorage).forEach(k => { if (k.startsWith('dr:space:')) localStorage.removeItem(k); }); } catch {}
      drResetSpaceContext();
      showToast('Logged out');
    });

    // Auth UI toggles
    (function(){
      const loginCard = document.querySelector('#authPanel .auth-card:nth-child(1)');
      if (loginCard) loginCard.id = 'loginCard';
      const regCard = document.getElementById('registerCard');
      const showReg = document.getElementById('showRegisterLink');
      const cancelReg = document.getElementById('cancelRegisterLink');
      if (showReg) showReg.addEventListener('click', (e) => { e.preventDefault(); if (regCard) regCard.hidden = false; if (loginCard) loginCard.hidden = true; });
      if (cancelReg) cancelReg.addEventListener('click', (e) => { e.preventDefault(); if (regCard) regCard.hidden = true; if (loginCard) loginCard.hidden = false; });
    })();

    document.getElementById('createSpaceBtn').addEventListener('click', async () => {
      const name = document.getElementById('newSpaceName').value.trim();
      if (!name) return;
      try {
        const resp = await api('/api/spaces', { method: 'POST', body: { name } });
        await initUser();
        document.getElementById('newSpaceName').value = '';
        showToast('Space created');
      } catch (e) { showToast('Failed to create space'); }
    });
    document.getElementById('setDefaultSpaceBtn').addEventListener('click', async () => {
      const sel = document.getElementById('spacesSelect');
      const sid = parseInt(sel.value || '0', 10);
      if (!sid) return;
      try {
        await api('/api/spaces/default', { method: 'POST', body: { space_id: sid } });
        await initUser();
        showToast('Default space updated');
      } catch (e) { showToast('Failed to set default'); }
    });
    document.getElementById('spacesSelect').addEventListener('change', (e) => {
      const sid = parseInt(e.target.value || '0', 10);
      state.spaceId = sid || state.spaceId;
      // Switch to a separate conversation per-space; resume from storage on next open
      drResetSpaceContext();
      const topSel = document.getElementById('topbarSpaceSelect');
      if (topSel && topSel.value !== String(state.spaceId)) topSel.value = String(state.spaceId);
      loadKB();
    });

    document.getElementById('topbarSpaceSelect').addEventListener('change', (e) => {
      const sid = parseInt(e.target.value || '0', 10);
      if (!sid) return;
      state.spaceId = sid;
      const accountSel = document.getElementById('spacesSelect');
      if (accountSel && accountSel.value !== String(state.spaceId)) accountSel.value = String(state.spaceId);
      drResetSpaceContext();
      loadKB();
      showToast('Space updated');
    });

    // Search
    function renderResults(hits, query) {
      const wrap = document.getElementById('results');
      const row = document.getElementById('resultsRow');
      if (wrap) wrap.classList.remove('is-visible');
      if (row) row.classList.remove('is-visible');
      wrap.innerHTML = '';
      const limited = Array.isArray(hits) ? hits.slice(0, 10) : [];
      if (!limited.length) {
        row.hidden = false;
        wrap.textContent = 'No results';
        requestAnimationFrame(() => {
          if (row) row.classList.add('is-visible');
        });
        return;
      }
      const items = limited.map((h, idx) => {
        const title = h.title ? escapeHtml(h.title) : '';
        const fname = h.file_name ? escapeHtml(h.file_name) : '';
        const label = title || fname || '(untitled)';
        const distance = (h.distance !== null && h.distance !== undefined) ? `distance: ${h.distance.toFixed ? h.distance.toFixed(4) : h.distance}` : '';
        const rank = (h.rank !== null && h.rank !== undefined) ? `rank: ${h.rank.toFixed ? h.rank.toFixed(4) : h.rank}` : '';
        const badges = `${distance ? `<span class="badge">${distance}</span>` : ''}${rank ? `<span class="badge">${rank}</span>` : ''}`;
        return `<div class="hit"><details><summary>[${idx + 1}] ${label} ${badges}</summary><div class="hit-content">${highlight(h.content || '', query)}</div></details></div>`;
      }).join('');
      wrap.innerHTML = items;
      row.hidden = false;
      requestAnimationFrame(() => {
        if (wrap) wrap.classList.add('is-visible');
        if (row) row.classList.add('is-visible');
      });
    }

    let currentSearchController = null;
    let searchTimer = null;

    async function doSearch() {
      const query = searchInputEl.value.trim();
      const mode = document.getElementById('mode').value;
      const topk = parseInt(document.getElementById('topk').value || '25', 10);
      const ans = document.getElementById('answer');
      const answerRow = document.getElementById('answerRow');
      const loading = document.getElementById('searchLoading');
      const btn = document.getElementById('searchBtn');

      if (!query) { ans.textContent = ''; renderResults([], ''); return; }

      if (currentSearchController) currentSearchController.abort();
      const ctrl = new AbortController();
      currentSearchController = ctrl;

      loading.hidden = false;
      btn.disabled = true;
      ans.textContent = '';

      try {
        const provider = document.getElementById('provider')?.value || undefined;
        const data = await api('/api/search', { method: 'POST', body: { query, mode, top_k: topk, space_id: state.spaceId, llm_provider: provider }, signal: ctrl.signal });

        if (data.answer) {
          ans.textContent = data.answer;
          answerRow.hidden = false;
          const badge = document.getElementById('llmBadge');
          if (badge) {
            if (data.used_llm === true) {
              badge.textContent = 'LLM answer';
              badge.style.display = 'inline-block';
            } else {
              badge.textContent = 'Context-only';
              badge.style.display = 'inline-block';
            }
          }
          const refsEl = document.getElementById('refs');
          const refsLabel = document.getElementById('refsLabel');
          if (refsEl) {
            if (Array.isArray(data.references) && data.references.length) {
              const limitedRefs = data.references.slice(0, 10);
              refsEl.style.display = 'grid';
              if (refsLabel) refsLabel.style.display = 'block';
              const items = limitedRefs.map((r, idx) => {
                const fn = r.file_name || '';
                const ft = r.file_type || '';
                const docId = r.doc_id || null;
                const link = docId ? `<a href="/api/doc-download?doc_id=${docId}" target="_blank" rel="noopener" data-doc-id="${docId}">Download source</a>` : '';
                const match = data.hits.find(h => h.chunk_id === r.chunk_id);
                const txt = match ? highlight(match.content || '', query) : '';
                return `<div class="hit"><details><summary>[${idx+1}] ${escapeHtml(fn)}${ft ? ` (${escapeHtml(ft)})` : ''} ${link}</summary><div class="hit-content">${txt}</div></details></div>`;
              }).join('');
              refsEl.innerHTML = items;
            } else {
              refsEl.style.display = 'none';
              if (refsLabel) refsLabel.style.display = 'none';
              refsEl.innerHTML = '';
            }
          }
        }
        renderResults(data.hits, query);
      } catch (e) {
        if (e.name !== 'AbortError') {
          showToast('Search failed');
          console.error(e);
        }
      } finally {
        if (currentSearchController === ctrl) currentSearchController = null;
        loading.hidden = true;
        btn.disabled = false;
      }
    }

    document.addEventListener('keydown', (e) => {
      const q = document.getElementById('searchInput');
      if (e.key === 'Enter' && document.activeElement === q) {
        e.preventDefault();
        triggerUnifiedSearch();
      } else if (e.key === 'Escape') {
        searchInputEl.value = '';
        document.getElementById('answer').textContent = '';
        document.getElementById('answerRow').hidden = true;
        const res = document.getElementById('results');
        res.innerHTML = '';
        document.getElementById('resultsRow').hidden = true;
      }
    });

    // Unified search mode handling
    const searchInputEl = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const textModeBtn = document.getElementById('searchModeText');
    const imageModeBtn = document.getElementById('searchModeImage');
    const audioModeBtn = null;
    const textSettingsPane = document.getElementById('textSettings');
    const imageSettingsPane = document.getElementById('imageSettings');
    const imageResultsSection = document.getElementById('imageResultsSection');
    const imageTagsEl = document.getElementById('imageTags');
    const imageTopKEl = document.getElementById('imageTopK');
    const imageThumbSizeEl = document.getElementById('imageThumbSize');
    const imageFileEl = document.getElementById('imageFile');
    const imageResultsGrid = document.getElementById('imageResultsGrid');
    const imageEmptyState = document.getElementById('imageResultsEmpty');
    const imageLoading = document.getElementById('imageSearchLoading');
    const imagePreviewBackdrop = document.getElementById('imagePreviewBackdrop');
    const imagePreviewModal = document.getElementById('imagePreviewModal');
    const imagePreviewImg = document.getElementById('imagePreviewImg');
    const imagePreviewCaption = document.getElementById('imagePreviewCaption');
    const imagePreviewClose = document.getElementById('imagePreviewClose');
    const unifiedModeState = {
      active: 'text',
      imageHasResults: false,
    };

    function setSearchMode(nextMode) {
      if (nextMode === unifiedModeState.active) return;
      unifiedModeState.active = nextMode;
      if (nextMode === 'text') {
        textModeBtn.classList.add('active');
        textModeBtn.setAttribute('aria-selected', 'true');
        imageModeBtn.classList.remove('active');
        imageModeBtn.setAttribute('aria-selected', 'false');
        if (audioModeBtn) {
          audioModeBtn.classList.remove('active');
          audioModeBtn.setAttribute('aria-selected', 'false');
        }
        searchInputEl.placeholder = 'Search documents‚Ä¶';
        textSettingsPane.hidden = false;
        imageSettingsPane.hidden = true;
        searchBtn.textContent = 'Search';
        if (imageResultsSection) imageResultsSection.hidden = true;
      } else if (nextMode === 'image') {
        imageModeBtn.classList.add('active');
        imageModeBtn.setAttribute('aria-selected', 'true');
        textModeBtn.classList.remove('active');
        textModeBtn.setAttribute('aria-selected', 'false');
        if (audioModeBtn) {
          audioModeBtn.classList.remove('active');
          audioModeBtn.setAttribute('aria-selected', 'false');
        }
        searchInputEl.placeholder = "Describe the image you're looking for‚Ä¶";
        textSettingsPane.hidden = true;
        imageSettingsPane.hidden = false;
        searchBtn.textContent = 'Search';
        if (imageResultsSection) imageResultsSection.hidden = false;
        if (!unifiedModeState.imageHasResults) resetImageResults();
      }
    }

    textModeBtn.addEventListener('click', () => setSearchMode('text'));
    imageModeBtn.addEventListener('click', () => setSearchMode('image'));

    function triggerUnifiedSearch() {
      if (unifiedModeState.active === 'image') {
        clearTextResults();
      } else {
        resetImageResults();
      }
      if (unifiedModeState.active === 'image') {
        doImageSearch();
      } else {
        doSearch();
      }
    }

    searchBtn.addEventListener('click', () => triggerUnifiedSearch());

    searchInputEl.addEventListener('input', () => {
      const auto = document.getElementById('autoSearch')?.checked ?? false;
      const delay = parseInt(document.getElementById('debounceMs')?.value || '400', 10);
      if (auto && unifiedModeState.active === 'text') {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => doSearch().catch(console.error), delay);
      }
    });
    searchInputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && unifiedModeState.active === 'image') {
        e.preventDefault();
        triggerUnifiedSearch();
      }
    });

    [imageTagsEl, imageTopKEl].forEach((el) => {
      el?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && unifiedModeState.active === 'image') {
          e.preventDefault();
          triggerUnifiedSearch();
        }
      });
    });

    function clearTextResults() {
      const ans = document.getElementById('answer');
      const answerRow = document.getElementById('answerRow');
      const resultsRow = document.getElementById('resultsRow');
      const refsEl = document.getElementById('refs');
      const refsLabel = document.getElementById('refsLabel');
      const hits = document.getElementById('results');
      if (ans) ans.textContent = '';
      if (answerRow) answerRow.classList.remove('is-visible');
      if (resultsRow) resultsRow.classList.remove('is-visible');
      if (refsEl) refsEl.classList.remove('is-visible');
      if (hits) hits.innerHTML = '';
      if (refsEl) refsEl.innerHTML = '';
      if (answerRow) answerRow.hidden = true;
      if (resultsRow) resultsRow.hidden = true;
      if (refsLabel) refsLabel.style.display = 'none';
    }

    function resetImageResults() {
      imageResultsGrid.innerHTML = '';
      imageResultsGrid.classList.remove('is-visible');
      if (imageResultsSection) imageResultsSection.classList.remove('is-visible');
      unifiedModeState.imageHasResults = false;
      if (imageEmptyState) imageEmptyState.hidden = false;
      if (imageResultsSection) imageResultsSection.hidden = unifiedModeState.active !== 'image';
    }

    async function resetHomeView() {
      searchInputEl.value = '';
      clearTextResults();
      clearImageSearch();
      setSearchMode('text');
      setKbExpanded(false);
      setUploadExpanded(false);
      setAccountExpanded(false);
      setResearchExpanded(false);
      setActiveScreen('search');
      const settingsPanel = document.getElementById('settingsPanel');
      const settingsBtn = document.getElementById('settingsBtn');
      if (settingsPanel && !settingsPanel.hidden) settingsPanel.hidden = true;
      if (settingsBtn) settingsBtn.setAttribute('aria-expanded', 'false');
      if (state.user) {
        await initUser();
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function storageBadgeLabel(storageBackend) {
      if (!storageBackend) return 'Remote';
      const val = String(storageBackend).toLowerCase();
      if (val === 'local') return 'Local Storage';
      if (val === 'both') return 'Local + OCI';
      if (val === 'oci') return 'OCI';
      if (val === 's3') return 'S3';
      return val.toUpperCase();
    }

    function renderStorageBadge(storageBackend) {
      const label = storageBadgeLabel(storageBackend);
      return `<span class="badge badge-storage"><span class="storage-icon" aria-hidden="true">üóÑÔ∏è</span>${label}</span>`;
    }

    function renderImageResults(results) {
      imageResultsGrid.innerHTML = '';
      imageResultsGrid.classList.remove('is-visible');
      if (imageResultsSection) imageResultsSection.classList.remove('is-visible');
      if (!Array.isArray(results) || !results.length) {
        unifiedModeState.imageHasResults = false;
        if (imageEmptyState) imageEmptyState.hidden = false;
        return;
      }
      unifiedModeState.imageHasResults = true;
      if (imageEmptyState) imageEmptyState.hidden = true;
      if (imageResultsSection) imageResultsSection.hidden = false;
      const size = imageThumbSizeEl.value || 'medium';
      const cards = results.map((item) => {
        const rawThumb = item.thumbnail_url || item.thumbnail_object_url || item.thumbnail_path || item.file_path || '';
        const thumb = rawThumb ? escapeHtml(rawThumb) : '';
        const caption = escapeHtml(item.caption || 'Untitled image');
        const imageId = item.image_id != null ? String(item.image_id) : '';
        const fullImage = imageId ? `/api/image-assets/${encodeURIComponent(imageId)}` : (item.object_url || item.file_path || '');
        const tags = Array.isArray(item.tags) ? item.tags : [];
        const tagBadges = tags.map(t => `<span class="badge badge-soft">${escapeHtml(t)}</span>`).join('');
        const meta = [];
        if (item.score != null) {
          const score = (item.score ?? '').toFixed ? item.score.toFixed(3) : item.score;
          meta.push(`<span class="badge">score ${score}</span>`);
        }
        if (item.rank != null) meta.push(`<span class="badge">#${item.rank}</span>`);
        if (item.object_url || item.thumbnail_object_url) meta.push(renderStorageBadge(state.storageBackend));
        const docId = item.doc_id != null ? Number(item.doc_id) : null;
        const primaryHref = item.file_url || (docId != null ? `/api/doc-download?doc_id=${encodeURIComponent(docId)}` : '');
        const sourceLink = primaryHref ? `<a class="ghost" href="${escapeHtml(primaryHref)}" target="_blank" rel="noopener">Open document</a>` : '';
        return `
          <div class="image-card ${size}">
            <button class="image-card-thumb" type="button" data-image-full="${escapeHtml(fullImage)}" data-image-caption="${caption}">
              ${thumb ? `<img src="${thumb}" alt="result ${item.rank || ''}" loading="lazy" onerror="this.closest('.image-card-thumb').classList.add('no-thumb')" />` : '<div class="thumb-placeholder">No preview</div>'}
              <div class="image-thumb-overlay">View</div>
            </button>
            <div class="image-card-body">
              <div class="image-card-meta">${meta.join('')}</div>
              <p class="image-card-caption">${caption}</p>
              <div class="image-card-tags">${tagBadges || '<span class="muted">No tags</span>'}</div>
              <div class="image-card-actions">${sourceLink}</div>
            </div>
          </div>`;
      }).join('');
      imageResultsGrid.innerHTML = cards;
      requestAnimationFrame(() => {
        imageResultsGrid.classList.add('is-visible');
        if (imageResultsSection) imageResultsSection.classList.add('is-visible');
      });
    }

    function openImagePreview(src, caption) {
      if (!imagePreviewModal || !imagePreviewBackdrop || !imagePreviewImg) return;
      if (!src) return;
      imagePreviewImg.src = src;
      imagePreviewImg.alt = caption || 'Image preview';
      if (imagePreviewCaption) imagePreviewCaption.textContent = caption || '';
      imagePreviewBackdrop.hidden = false;
      imagePreviewModal.hidden = false;
      imagePreviewBackdrop.classList.add('open');
      imagePreviewModal.classList.add('open');
    }

    function closeImagePreview() {
      if (!imagePreviewModal || !imagePreviewBackdrop || !imagePreviewImg) return;
      imagePreviewModal.classList.remove('open');
      imagePreviewBackdrop.classList.remove('open');
      imagePreviewModal.hidden = true;
      imagePreviewBackdrop.hidden = true;
      imagePreviewImg.src = '';
      if (imagePreviewCaption) imagePreviewCaption.textContent = '';
    }

    async function doImageSearch() {
      if (!state.user) { showToast('Login required'); return; }
      const query = (searchInputEl.value || '').trim();
      const tagsRaw = imageTagsEl.value || '';
      const topK = parseInt(imageTopKEl.value || '12', 10);
      const file = imageFileEl.files && imageFileEl.files[0] ? imageFileEl.files[0] : null;

      if (!query && !tagsRaw && !file) {
        showToast('Enter a query, tags, or choose a reference image');
        return;
      }

      if (state.imageSearchAbort) {
        state.imageSearchAbort.abort();
        state.imageSearchAbort = null;
      }

      const controller = new AbortController();
      state.imageSearchAbort = controller;
      imageLoading.hidden = false;
      imageResultsGrid.innerHTML = '';
      if (imageResultsSection) imageResultsSection.hidden = false;
      if (imageEmptyState) imageEmptyState.hidden = true;

      try {
        const tags = tagsRaw.split(',').map(t => t.trim()).filter(Boolean);
        const payload = { query, tags, top_k: topK, space_id: state.spaceId };
        let body;
        let headers;
        if (file) {
          body = new FormData();
          Object.entries(payload).forEach(([k, v]) => {
            if (Array.isArray(v)) {
              body.append(k, JSON.stringify(v));
            } else if (v != null) {
              body.append(k, v);
            }
          });
          body.append('reference', file);
        } else {
          body = payload;
          headers = { 'Content-Type': 'application/json' };
        }
        const res = await api('/api/image-search', { method: 'POST', body, headers, signal: controller.signal });
        renderImageResults(res.results || []);
        showToast(`Found ${res.count || 0} images`);
      } catch (e) {
        if (e.name !== 'AbortError') {
          console.error(e);
          showToast('Image search failed');
        }
      } finally {
        imageLoading.hidden = true;
        if (state.imageSearchAbort === controller) state.imageSearchAbort = null;
      }
    }

    function clearImageSearch() {
      searchInputEl.value = '';
      imageTagsEl.value = '';
      imageTopKEl.value = '12';
      if (imageFileEl) imageFileEl.value = '';
      resetImageResults();
    }

    imageResultsGrid?.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-image-full]');
      if (!btn) return;
      const src = btn.getAttribute('data-image-full') || '';
      const caption = btn.getAttribute('data-image-caption') || '';
      openImagePreview(src, caption);
    });

    imagePreviewClose?.addEventListener('click', closeImagePreview);
    imagePreviewBackdrop?.addEventListener('click', closeImagePreview);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && imagePreviewModal && !imagePreviewModal.hidden) {
        closeImagePreview();
      }
    });

    const drEls = {
      modal: document.getElementById('drModal'),
      backdrop: document.getElementById('drBackdrop'),
      message: document.getElementById('drMessage'),
      send: document.getElementById('drSend'),
      close: document.getElementById('drClose'),
      reset: document.getElementById('drReset'),
      newSession: document.getElementById('drNewSession'),
      hero: document.getElementById('drHero'),
      sourceTicker: document.getElementById('drSourceTicker'),
      sourceTickerText: document.getElementById('drSourceTickerText'),
      heroStatus: document.getElementById('drHeroStatus'),
      streamIndicator: document.getElementById('drStreamIndicator'),
      webStatus: document.getElementById('drWebStatus'),
      ingestStatus: document.getElementById('drIngestStatus'),
      forceWeb: document.getElementById('drForceWeb'),
      titleInput: document.getElementById('drActiveTitle'),
      renameBtn: document.getElementById('drRenameBtn'),
      refreshBtn: document.getElementById('drSessionRefresh'),
      updatedAt: document.getElementById('drUpdatedAt'),
      timeline: document.getElementById('drTimeline'),
      emptyState: document.getElementById('drEmptyState'),
      convoList: document.getElementById('drConvoList'),
      sessionsToggle: document.getElementById('drSessionsToggle'),
      notebookToggle: document.getElementById('drNotebookToggle'),
      sessionsToggleSecondary: document.getElementById('drSessionsToggleSecondary'),
      notebookToggleSecondary: document.getElementById('drNotebookToggleSecondary'),
      sessionsDrawer: document.getElementById('drSessionsDrawer'),
      notebookDrawer: document.getElementById('drNotebookDrawer'),
      drawerBackdrop: document.getElementById('drDrawerBackdrop'),
      drawerCloseButtons: document.querySelectorAll('[data-dr-drawer-close]'),
      newSessionDrawerBtn: document.getElementById('drNewSessionDrawer'),
      notebookForm: document.getElementById('drNotebookForm'),
      notebookTitle: document.getElementById('drNotebookTitle'),
      notebookContent: document.getElementById('drNotebookContent'),
      notebookClear: document.getElementById('drNotebookClear'),
      notebookList: document.getElementById('drNotebookList'),
      notebookEmpty: document.getElementById('drNotebookEmpty'),
      notebookRefresh: document.getElementById('drNotebookRefresh'),
      menuBtn: document.getElementById('drMenuBtn'),
      menuPanel: document.getElementById('drMenu'),
      menuSessions: document.getElementById('drMenuSessions'),
      menuNotebook: document.getElementById('drMenuNotebook'),
      menuReset: document.getElementById('drMenuReset'),
      followupBackdrop: document.getElementById('drFollowupBackdrop'),
      followupModal: document.getElementById('drFollowupModal'),
      followupQuestion: document.getElementById('drFollowupQuestion'),
      followupAnswer: document.getElementById('drFollowupAnswer'),
      followupSend: document.getElementById('drFollowupSend'),
      followupCancel: document.getElementById('drFollowupCancel'),
      followupClose: document.getElementById('drFollowupClose'),
    };

    const drState = {
      open: false,
      conversationId: null,
      conversations: [],
      steps: [],
      notebook: [],
      isSending: false,
      followupAutoSend: true,
      pendingFollowup: null,
      pipelineTimers: [],
    };

    function drGetDrawer(which) {
      if (which === 'sessions') return drEls.sessionsDrawer;
      if (which === 'notebook') return drEls.notebookDrawer;
      return null;
    }

    function drShowDrawer(which) {
      const drawer = drGetDrawer(which);
      if (!drawer) return;
      drawer.classList.add('open');
      if (drEls.drawerBackdrop) {
        drEls.drawerBackdrop.hidden = false;
        drEls.drawerBackdrop.classList.add('open');
      }
    }

    function drHideDrawer(which) {
      const drawer = drGetDrawer(which);
      if (!drawer) return;
      drawer.classList.remove('open');
    }

    function drHideAllDrawers() {
      drHideDrawer('sessions');
      drHideDrawer('notebook');
      if (drEls.drawerBackdrop) {
        drEls.drawerBackdrop.classList.remove('open');
        drEls.drawerBackdrop.hidden = true;
      }
    }

    function drToggleMenu(forceState) {
      if (!drEls.menuPanel || !drEls.menuBtn) return;
      const willOpen = typeof forceState === 'boolean'
        ? forceState
        : drEls.menuPanel.hidden;
      drEls.menuPanel.hidden = !willOpen;
      drEls.menuBtn.setAttribute('aria-expanded', String(willOpen));
    }

    function drToggleDrawer(which) {
      const drawer = drGetDrawer(which);
      if (!drawer) return;
      const willOpen = !drawer.classList.contains('open');
      drHideAllDrawers();
      if (willOpen) drShowDrawer(which);
    }

    function drStorageKey(spaceId) {
      return `dr:space:${spaceId || '_'}`;
    }

    function drPersistConversationId(conversationId) {
      const key = drStorageKey(state.spaceId);
      try {
        if (conversationId) {
          localStorage.setItem(key, conversationId);
        } else {
          localStorage.removeItem(key);
        }
      } catch {}
    }

    function drRestoreConversationId() {
      const key = drStorageKey(state.spaceId);
      try {
        return localStorage.getItem(key);
      } catch {
        return null;
      }
    }

    function drSetHeroStatus(text) {
      if (drEls.heroStatus) drEls.heroStatus.textContent = text;
    }

    function drSetStreamIndicator(active) {
      if (!drEls.streamIndicator) return;
      drEls.streamIndicator.hidden = !active;
    }


    function drShowSourceTicker(labels) {
      if (!drEls.sourceTicker || !drEls.sourceTickerText) return;
      const text = (labels || []).filter(Boolean).join(' ‚Ä¢ ');
      if (!text) return;
      drEls.sourceTickerText.textContent = text;
      drEls.sourceTicker.hidden = false;
      drEls.sourceTicker.classList.add('active');
      setTimeout(() => {
        drEls.sourceTicker.classList.remove('active');
        drEls.sourceTicker.hidden = true;
      }, 4500);
    }

    function drCollectTickerLabels(refs = []) {
      if (!Array.isArray(refs) || !refs.length) return [];
      return refs
        .filter(ref => ref.source === 'local' || ref.source === 'web' || ref.source === 'url')
        .slice(0, 3)
        .map(ref => ref.title || ref.url || ref.source_path || 'Source');
    }

    function drSetIngesting(active) {
      if (!drEls.ingestStatus) return;
      drEls.ingestStatus.hidden = !active;
    }

    function drGenerateSessionTitle() {
      const email = state.user?.email || 'session';
      const prefix = email.split('@')[0] || 'session';
      const hash = Math.random().toString(36).slice(2, 8);
      return `${prefix}-${hash}`;
    }

    async function drAutoSaveSessionTitle() {
      if (!drState.conversationId || !drEls.titleInput) return;
      let title = drEls.titleInput.value.trim();
      if (!title) {
        title = drGenerateSessionTitle();
        drEls.titleInput.value = title;
      }
      try {
        await api(`/api/deep-research/conversations/${encodeURIComponent(drState.conversationId)}/title`, {
          method: 'POST',
          body: { title },
        });
        await drFetchConversations();
        drRenderConversations();
      } catch (e) {
        console.error(e);
      }
    }

    function drUpdateWebStatus(webAttempted) {
      if (!drEls.webStatus) return;
      if (webAttempted) {
        drEls.webStatus.textContent = 'Web search included';
        drEls.webStatus.classList.remove('warning');
      } else {
        drEls.webStatus.textContent = 'Local knowledge only (toggle to force web)';
        drEls.webStatus.classList.add('warning');
      }
    }

    function renderDrMetadata(meta) {
      if (!meta) return '';
      const parts = [];
      if (typeof meta.confidence === 'number') {
        parts.push(`<span class="badge">Confidence ${(meta.confidence * 100).toFixed(0)}%</span>`);
      }
      if (typeof meta.elapsed_seconds === 'number') {
        const secs = Number(meta.elapsed_seconds);
        parts.push(`<span class="badge badge-soft">${Number.isFinite(secs) ? secs.toFixed(2) : meta.elapsed_seconds}s</span>`);
      }
      if (meta.web_attempted) {
        parts.push('<span class="badge badge-web">Web search triggered</span>');
      } else {
        parts.push('<span class="badge badge-local">Local context only</span>');
      }
      return parts.join('');
    }

    function renderFollowupQuestions(questions) {
      if (!Array.isArray(questions) || !questions.length) return '';
      const items = questions.map(q => `<button type="button" class="dr-followup-chip">${escapeHtml(q)}</button>`).join('');
      return `
        <div class="dr-followup">
          <div class="dr-followup-title">Suggested follow-up questions</div>
          <div class="dr-followup-chips">${items}</div>
        </div>`;
    }

    function normalizeUrl(raw) {
      if (!raw || typeof raw !== 'string') return '#';
      const trimmed = raw.trim();
      if (!trimmed) return '#';
      if (/^https?:\/\//i.test(trimmed)) return trimmed;
      if (/^[a-z]+:\/\//i.test(trimmed)) return trimmed;
      return `https://${trimmed.replace(/^\/+/, '')}`;
    }

    function renderDrReferences(refs) {
      if (!Array.isArray(refs) || !refs.length) return '';
      const localRefs = refs.filter(r => r.source === 'local');
      const webRefs = refs.filter(r => r.source === 'web');

      const buildChunkCard = (ref, idx, type) => {
        const num = ref.rank ?? (idx + 1);
        const title = escapeHtml(ref.title || (type === 'local' ? basename(ref.source_path || '') || `Document ${ref.document_id ?? idx + 1}` : `Web result ${idx + 1}`));
        const chunkLabel = typeof ref.chunk_index === 'number' ? `Chunk #${ref.chunk_index}` : null;
        const subtitleBits = [];
        if (chunkLabel) subtitleBits.push(chunkLabel);
        if (type === 'local' && ref.source_path) subtitleBits.push(basename(ref.source_path));
        if (type === 'web' && ref.url) subtitleBits.push(ref.url.replace(/^https?:\/\//, ''));
        const subtitle = subtitleBits.join(' ‚Ä¢ ');
        const textField = type === 'local' ? (ref.excerpt || ref.snippet || ref.text || '') : (ref.snippet || ref.excerpt || '');
        const trimmed = textField.trim();
        const display = trimmed ? escapeHtml(trimmed.length > 320 ? `${trimmed.slice(0, 320)}‚Ä¶` : trimmed) : '<span class="muted">No excerpt available.</span>';
        const downloadHref = type === 'local' && ref.document_id ? `/api/doc-download?doc_id=${encodeURIComponent(ref.document_id)}` : '';
        const badge = type === 'local' ? '<span class="pill-badge">Local</span>' : '<span class="pill-badge pill-web">Web</span>';
        const action = type === 'local'
          ? (downloadHref ? `<a class="ghost" href="${escapeHtml(downloadHref)}" target="_blank" rel="noopener">Open document</a>` : '')
          : `<a class="ghost" href="${escapeHtml(normalizeUrl(ref.url))}" target="_blank" rel="noopener">Open link</a>`;
        return `
          <details class="dr-source-card" data-source="${type}">
            <summary>
              <div class="dr-source-chip">${badge}<span class="rank">#${num}</span></div>
              <div class="dr-source-summary">
                <div class="title">${title}</div>
                ${subtitle ? `<div class="sub">${escapeHtml(subtitle)}</div>` : ''}
              </div>
              <span class="chevron">‚ñ∏</span>
            </summary>
            <div class="dr-source-body">
              <div class="snippet">${display}</div>
              <div class="actions">${action || ''}</div>
            </div>
          </details>`;
      };

      const buildDeck = (items, typeLabel, type) => {
        if (!items.length) return '';
        return `
          <details class="dr-source-deck" data-type="${type}">
            <summary>
              <div class="deck-header">
                <span class="deck-title">${typeLabel}</span>
                <span class="deck-count">${items.length} item${items.length === 1 ? '' : 's'}</span>
                <span class="chevron">‚ñ∏</span>
              </div>
            </summary>
            <div class="deck-body">
              ${items.map((ref, idx) => buildChunkCard(ref, idx, type)).join('')}
            </div>
          </details>`;
      };

      const decks = [
        buildDeck(localRefs, 'Knowledge Base Sources', 'local'),
        buildDeck(webRefs, 'Web Sources', 'web'),
      ].filter(Boolean).join('');

      return `
        <details class="dr-sources">
          <summary>
            <span class="pill-badge pill-source">Sources</span>
            <span class="muted">Tap to expand local & web evidence</span>
            <span class="chevron">‚ñ∏</span>
          </summary>
          <div class="dr-sources-body">
            ${decks || '<div class="muted">No supporting evidence returned.</div>'}
          </div>
        </details>`;
    }

    function drRenderTimeline(steps = drState.steps) {
      const chat = drEls.timeline;
      if (!chat) return;
      chat.innerHTML = '';
      if (!steps.length) {
        if (drEls.emptyState) drEls.emptyState.hidden = false;
        chat.hidden = true;
        return;
      }
      if (drEls.emptyState) drEls.emptyState.hidden = true;
      chat.hidden = false;
      const frag = document.createDocumentFragment();
      steps.forEach((step) => {
        const div = document.createElement('div');
        div.className = 'dr-msg ' + (step.role === 'user' ? 'me' : 'ai');
        const ts = step.created_at ? `<div class="muted" style="font-size:11px;margin-bottom:4px;">${new Date(step.created_at).toLocaleString()}</div>` : '';
        if (step.role === 'assistant') {
          const references = step.context_refs && step.context_refs.length ? step.context_refs : step.metadata?.references;
          const meta = step.metadata || {};
          const badges = renderDrMetadata(meta);
          const followups = renderFollowupQuestions(meta.followup_questions || []);
          div.innerHTML = `<div class="bubble">${ts}${badges ? `<div class="dr-meta">${badges}</div>` : ''}${renderLLMText(step.content || '')}${followups}${renderDrReferences(references)}</div>`;
        } else {
          div.innerHTML = `<div class="bubble">${ts}<p>${escapeHtml(step.content || '')}</p></div>`;
        }
        frag.appendChild(div);
        if (step.pending) {
          const pending = document.createElement('div');
          pending.className = 'dr-msg dr-msg-pending';
          pending.innerHTML = `
            <div class="dr-thinking-inline" aria-live="polite">
              <div class="dr-typing-dots" aria-hidden="true">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>`;
          frag.appendChild(pending);
        }
      });
      chat.appendChild(frag);
      chat.scrollTop = chat.scrollHeight;
    }

    function drRenderNotebook(list = drState.notebook) {
      if (!drEls.notebookList || !drEls.notebookEmpty) return;
      drEls.notebookList.innerHTML = '';
      if (!list.length) {
        drEls.notebookEmpty.hidden = false;
        return;
      }
      drEls.notebookEmpty.hidden = true;
      const frag = document.createDocumentFragment();
      list.forEach((entry) => {
        const card = document.createElement('div');
        card.className = 'dr-note-card';
        card.dataset.entryId = entry.entry_id;
        card.innerHTML = `
          <h4>${escapeHtml(entry.title || 'Notebook entry')}</h4>
          <p>${escapeHtml(entry.content || '')}</p>
          <div class="note-meta">
            <span>${entry.created_at ? new Date(entry.created_at).toLocaleString() : ''}</span>
            <div class="note-actions">
              <button type="button" class="ghost" data-dr-delete-note="${entry.entry_id}">Delete</button>
            </div>
          </div>
        `;
        frag.appendChild(card);
      });
      drEls.notebookList.appendChild(frag);
    }

    function drRenderConversations() {
      if (!drEls.convoList) return;
      drEls.convoList.innerHTML = '';
      if (!drState.conversations.length) {
        drEls.convoList.innerHTML = '<div class="muted">No sessions yet. Start a new one.</div>';
        return;
      }
      const frag = document.createDocumentFragment();
      drState.conversations.forEach((convo) => {
        const div = document.createElement('div');
        div.className = 'dr-convo-card' + (convo.conversation_id === drState.conversationId ? ' active' : '');
        div.dataset.drConversation = convo.conversation_id;
        const snippetRaw = (convo.first_question || '').trim();
        const snippet = snippetRaw.length > 140 ? `${snippetRaw.slice(0, 140)}‚Ä¶` : snippetRaw;
        const updated = convo.updated_at ? new Date(convo.updated_at).toLocaleString() : '';
        div.innerHTML = `
          <div class="snippet">${escapeHtml(snippet || 'No question yet')}</div>
          <div class="meta">
            <span>${convo.step_count || 0} steps</span>
            ${updated ? `<span>${escapeHtml(updated)}</span>` : ''}
          </div>
        `;
        frag.appendChild(div);
      });
      drEls.convoList.appendChild(frag);
    }

    function drOpenFollowupModal(question) {
      if (!drEls.followupModal || !drEls.followupBackdrop) return;
      drState.pendingFollowup = question;
      if (drEls.followupQuestion) drEls.followupQuestion.textContent = question || '';
      if (drEls.followupAnswer) drEls.followupAnswer.value = '';
      drEls.followupBackdrop.hidden = false;
      drEls.followupModal.hidden = false;
      drEls.followupBackdrop.classList.add('open');
      drEls.followupModal.classList.add('open');
      drEls.followupAnswer?.focus();
    }

    function drCloseFollowupModal() {
      if (!drEls.followupModal || !drEls.followupBackdrop) return;
      drEls.followupBackdrop.classList.remove('open');
      drEls.followupModal.classList.remove('open');
      drEls.followupBackdrop.hidden = true;
      drEls.followupModal.hidden = true;
      drState.pendingFollowup = null;
    }

    async function drSubmitMessage(text) {
      if (!text || drState.isSending) return;
      drState.isSending = true;
      drSetStreamIndicator(true);
      drSetIngesting(false);
      drState.pipelineTimers = [];
      const tmpStep = { role: 'user', content: text, created_at: new Date().toISOString(), pending: true };
      drRenderTimeline([...drState.steps, tmpStep]);
      try {
        const cid = await drEnsureConversationId();
        if (!cid) throw new Error('No conversation');
        if (drEls.titleInput && !drEls.titleInput.value.trim()) {
          drEls.titleInput.value = drGenerateSessionTitle();
        }
        const provider = document.getElementById('provider')?.value || undefined;
        const body = {
          conversation_id: cid,
          message: text,
          space_id: state.spaceId,
          llm_provider: provider,
          force_web: drEls.forceWeb?.checked || false,
        };
        const urls = drExtractUrlsFromText(text);
        if (urls.length) {
          body.urls = urls;
          drSetIngesting(true);
        }
        const resp = await api('/api/deep-research/ask', { method: 'POST', body });
        drUpdateWebStatus(Boolean(resp.web_attempted));
        if (resp && Array.isArray(resp.references)) {
          drShowSourceTicker(drCollectTickerLabels(resp.references));
        }
        await drAutoSaveSessionTitle();
        await drFetchConversations();
        await drLoadConversationDetail(cid);
      } catch (e) {
        console.error(e);
        showToast('Failed to send research question');
        await drLoadConversationDetail(drState.conversationId);
      } finally {
        drState.isSending = false;
        drSetStreamIndicator(false);
        drSetIngesting(false);
        drState.pipelineTimers = [];
      }
    }

    async function drStartConversation() {
      const payload = { space_id: state.spaceId };
      const r = await api('/api/deep-research/start', { method: 'POST', body: payload });
      return r.conversation_id;
    }

    async function drFetchConversations() {
      if (!state.user) return [];
      const params = state.spaceId ? `?space_id=${encodeURIComponent(state.spaceId)}` : '';
      try {
        const res = await api(`/api/deep-research/conversations${params}`);
        drState.conversations = Array.isArray(res.conversations) ? res.conversations : [];
        drRenderConversations();
        return drState.conversations;
      } catch (e) {
        console.error(e);
        showToast('Failed to load sessions');
        drState.conversations = [];
        drRenderConversations();
        return [];
      }
    }

    async function drLoadConversationDetail(conversationId) {
      if (!conversationId) return;
      try {
        const detail = await api(`/api/deep-research/conversations/${encodeURIComponent(conversationId)}`);
        drState.steps = detail.steps || [];
        drState.notebook = detail.notebook || [];
        drRenderTimeline();
        drRenderNotebook();
        const convo = detail.conversation || {};
        if (drEls.titleInput) {
          if (convo.title) {
            drEls.titleInput.value = convo.title;
          } else {
            drEls.titleInput.value = drGenerateSessionTitle();
            drAutoSaveSessionTitle();
          }
        }
        if (drEls.updatedAt) drEls.updatedAt.textContent = convo.updated_at ? `Updated ${new Date(convo.updated_at).toLocaleString()}` : '';
        drSetHeroStatus(drState.steps.length ? `${drState.steps.length} steps captured` : 'Ask a question to begin.');
        const lastAssistant = [...drState.steps].reverse().find(step => step.role === 'assistant');
        if (lastAssistant) {
          drUpdateWebStatus(Boolean(lastAssistant.metadata?.web_attempted));
          drShowSourceTicker(drCollectTickerLabels(lastAssistant.context_refs || lastAssistant.metadata?.references || []));
        }
      } catch (e) {
        console.error(e);
        showToast('Failed to load conversation');
      }
    }

    async function drEnsureConversationId({ allowCreate = true } = {}) {
      if (drState.conversationId) return drState.conversationId;
      const restored = drRestoreConversationId();
      if (restored) {
        drState.conversationId = restored;
        return restored;
      }
      if (!allowCreate || !state.spaceId) return null;
      const cid = await drStartConversation();
      drState.conversationId = cid;
      drPersistConversationId(cid);
      return cid;
    }

    async function drSelectConversation(conversationId, { refreshList = false } = {}) {
      if (!conversationId) return;
      drState.conversationId = conversationId;
      drPersistConversationId(conversationId);
      if (refreshList) await drFetchConversations();
      drRenderConversations();
      await drLoadConversationDetail(conversationId);
    }

    async function drBootstrap() {
      if (!state.user) {
        showToast('Login required');
        return;
      }
      await drFetchConversations();
      const restored = drRestoreConversationId();
      const exists = drState.conversations.find(c => c.conversation_id === restored);
      if (exists) {
        await drSelectConversation(restored);
        return;
      }
      if (drState.conversations.length) {
        await drSelectConversation(drState.conversations[0].conversation_id);
        return;
      }
      if (state.spaceId) {
        const cid = await drStartConversation();
        await drFetchConversations();
        await drSelectConversation(cid);
      } else {
        drSetHeroStatus('Choose a space to start Deep Research.');
      }
    }

    async function drOpenModal() {
      if (!state.user) {
        showToast('Login required');
        return;
      }
      if (!drEls.modal || !drEls.backdrop) return;
      drEls.backdrop.hidden = false;
      drEls.backdrop.classList.add('open');
      drEls.modal.hidden = false;
      drEls.modal.classList.add('open');
      if (drEls.forceWeb && typeof drEls.forceWeb.checked === 'boolean') {
        drEls.forceWeb.checked = false;
      }
      drState.open = true;
      drHideAllDrawers();
      drEls.message?.focus();
      drSetHeroStatus('Loading sessions‚Ä¶');
      await drBootstrap();
    }

    function drCloseModal() {
      if (!drEls.modal || !drEls.backdrop) return;
      drEls.backdrop.classList.remove('open');
      drEls.backdrop.hidden = true;
      drEls.modal.classList.remove('open');
      drEls.modal.hidden = true;
      drState.open = false;
      drSetStreamIndicator(false);
      drHideAllDrawers();
      drToggleMenu(false);
      drAutoSaveSessionTitle();
    }

    function drExtractUrlsFromText(raw) {
      if (!raw) return [];
      const urlRegex = /https?:\/\/[^\s)]+/gi;
      const matches = raw.match(urlRegex) || [];
      // Deduplicate while preserving order
      const seen = new Set();
      const urls = [];
      for (const url of matches) {
        if (seen.has(url)) continue;
        seen.add(url);
        urls.push(url);
      }
      return urls;
    }

    async function drHandleSend() {
      if (drState.isSending) return;
      if (!state.user) { showToast('Login required'); return; }
      const text = (drEls.message?.value || '').trim();
      if (!text) return;
      drEls.message.value = '';
      await drSubmitMessage(text);
    }

    async function drHandleRename() {
      if (!drState.conversationId || !drEls.titleInput) return;
      const title = drEls.titleInput.value.trim();
      if (!title) { showToast('Title cannot be empty'); return; }
      try {
        await api(`/api/deep-research/conversations/${encodeURIComponent(drState.conversationId)}/title`, {
          method: 'POST',
          body: { title },
        });
        showToast('Session renamed');
        await drFetchConversations();
        drRenderConversations();
      } catch (e) {
        console.error(e);
        showToast('Failed to rename session');
      }
    }

    async function drHandleNewSession() {
      if (!state.spaceId) { showToast('Select a space first'); return; }
      try {
        const cid = await drStartConversation();
        drState.conversationId = cid;
        drPersistConversationId(cid);
        await drFetchConversations();
        await drSelectConversation(cid);
        if (drEls.titleInput) {
          drEls.titleInput.value = drGenerateSessionTitle();
          await drAutoSaveSessionTitle();
        }
        showToast('New session ready');
      } catch (e) {
        console.error(e);
        showToast('Failed to start session');
      }
    }

    async function drHandleReset() {
      await drHandleNewSession();
    }

    async function drHandleNotebookSubmit(e) {
      e.preventDefault();
      if (!drState.conversationId) { showToast('Open a session first'); return; }
      const title = drEls.notebookTitle?.value.trim() || 'Notebook entry';
      const content = drEls.notebookContent?.value.trim() || '';
      if (!content) { showToast('Content required'); return; }
      try {
        await api(`/api/deep-research/notebook/${encodeURIComponent(drState.conversationId)}`, {
          method: 'POST',
          body: { title, content },
        });
        drEls.notebookTitle.value = '';
        drEls.notebookContent.value = '';
        await drLoadConversationDetail(drState.conversationId);
        showToast('Notebook entry added');
      } catch (e) {
        console.error(e);
        showToast('Failed to add note');
      }
    }

    async function drDeleteNotebookEntry(entryId) {
      try {
        await api(`/api/deep-research/notebook/${encodeURIComponent(entryId)}`, { method: 'DELETE' });
        await drLoadConversationDetail(drState.conversationId);
      } catch (e) {
        console.error(e);
        showToast('Failed to delete note');
      }
    }

    function drResetSpaceContext() {
      drState.conversationId = null;
      drPersistConversationId(null);
      drState.steps = [];
      drState.notebook = [];
      drRenderTimeline([]);
      drRenderNotebook([]);
      drRenderConversations();
      drSetHeroStatus('Space switched. Open Deep Research to resume.');
    }

    function setActiveScreen(screenId) {
      const screens = document.querySelectorAll('.app-screen');
      screens.forEach((screen) => {
        screen.classList.toggle('active', screen.dataset.screen === screenId);
      });
      const navItems = document.querySelectorAll('.bottom-nav__item');
      navItems.forEach((item) => {
        item.classList.toggle('active', item.dataset.screenTarget === screenId);
      });
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.querySelectorAll('.bottom-nav__item[data-screen-target]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.screenTarget;
        if (!target) return;
        if (!state.user && target !== 'account' && target !== 'search') {
          setActiveScreen('library');
          setKbExpanded(false);
          setUploadExpanded(false);
          setResearchExpanded(false);
          showToast('Sign in to access your library.');
          return;
        }
        setActiveScreen(target);
      });
    });

    const researchOpenBtn = document.getElementById('researchOpenBtn');
    researchOpenBtn?.addEventListener('click', () => {
      drOpenModal().catch(console.error);
    });

    // Event wiring for Deep Research UI
    document.getElementById('drBtn')?.addEventListener('click', () => { drOpenModal().catch(console.error); });
    document.getElementById('bottomNavResearch')?.addEventListener('click', () => {
      if (!state.user) {
        showToast('Sign in to start research');
        setActiveScreen('account');
        return;
      }
    });
    document.getElementById('bottomNavAccount')?.addEventListener('click', () => {
      if (!state.user) {
        showToast('Sign in to manage your account');
        setActiveScreen('account');
        setAccountExpanded(true);
      } else {
        showToast(`Signed in as ${state.user.email}`);
      }
    });

    document.getElementById('landingCtaBtn')?.addEventListener('click', () => {
      setActiveScreen('account');
      setAccountExpanded(true);
    });

    document.getElementById('landingLearnBtn')?.addEventListener('click', () => {
      showToast('Sign in to explore SpacesAI features.');
      setActiveScreen('account');
      setAccountExpanded(true);
    });
    drEls.close?.addEventListener('click', () => drCloseModal());
    drEls.backdrop?.addEventListener('click', () => drCloseModal());
    drEls.send?.addEventListener('click', () => drHandleSend());
    drEls.message?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        drHandleSend();
      }
    });
    drEls.reset?.addEventListener('click', () => drHandleReset());
    drEls.newSession?.addEventListener('click', () => drHandleNewSession());
    drEls.renameBtn?.addEventListener('click', () => drHandleRename());
    drEls.refreshBtn?.addEventListener('click', () => {
      drHandleReset();
    });
    drEls.titleInput?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        drHandleRename();
      }
    });
    drEls.titleInput?.addEventListener('blur', () => drAutoSaveSessionTitle());
    drEls.titleInput?.addEventListener('focus', () => {
      drEls.renameBtn?.classList.add('visible');
    });
    drEls.titleInput?.addEventListener('blur', () => {
      drEls.renameBtn?.classList.remove('visible');
    });
    drEls.notebookForm?.addEventListener('submit', drHandleNotebookSubmit);
    drEls.notebookClear?.addEventListener('click', () => {
      if (drEls.notebookTitle) drEls.notebookTitle.value = '';
      if (drEls.notebookContent) drEls.notebookContent.value = '';
    });
    drEls.notebookRefresh?.addEventListener('click', () => {
      if (drState.conversationId) drLoadConversationDetail(drState.conversationId);
    });
    drEls.convoList?.addEventListener('click', (e) => {
      const card = e.target.closest('[data-dr-conversation]');
      if (card) drSelectConversation(card.dataset.drConversation);
    });
    drEls.notebookList?.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-dr-delete-note]');
      if (btn) drDeleteNotebookEntry(btn.getAttribute('data-dr-delete-note'));
    });

    [drEls.sessionsToggle, drEls.sessionsToggleSecondary].forEach((btn) => {
      btn?.addEventListener('click', () => drToggleDrawer('sessions'));
    });
    [drEls.notebookToggle, drEls.notebookToggleSecondary].forEach((btn) => {
      btn?.addEventListener('click', () => drToggleDrawer('notebook'));
    });
    drEls.drawerCloseButtons?.forEach((btn) => {
      btn.addEventListener('click', () => drHideAllDrawers());
    });
    drEls.drawerBackdrop?.addEventListener('click', () => drHideAllDrawers());
    drEls.newSessionDrawerBtn?.addEventListener('click', () => {
      drHandleNewSession();
      drHideDrawer('sessions');
    });

    drEls.menuBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      drToggleMenu();
    });
    drEls.menuSessions?.addEventListener('click', () => {
      drToggleMenu(false);
      drToggleDrawer('sessions');
    });
    drEls.menuNotebook?.addEventListener('click', () => {
      drToggleMenu(false);
      drToggleDrawer('notebook');
    });
    drEls.menuReset?.addEventListener('click', () => {
      drToggleMenu(false);
      drHandleReset();
    });
    drEls.timeline?.addEventListener('click', (e) => {
      const chip = e.target.closest('.dr-followup-chip');
      if (!chip || !drEls.message) return;
      const text = (chip.textContent || '').trim();
      if (!text) return;
      if (drState.isSending) return;
      drOpenFollowupModal(text);
    });
    drEls.followupSend?.addEventListener('click', async () => {
      const question = drState.pendingFollowup || '';
      const answer = (drEls.followupAnswer?.value || '').trim();
      if (!question) { showToast('No follow-up selected'); return; }
      if (!answer) { showToast('Please add your response'); return; }
      drCloseFollowupModal();
      const combined = `Follow-up question: ${question}\nUser response: ${answer}`;
      await drSubmitMessage(combined);
    });
    drEls.followupCancel?.addEventListener('click', () => drCloseFollowupModal());
    drEls.followupClose?.addEventListener('click', () => drCloseFollowupModal());
    drEls.followupBackdrop?.addEventListener('click', () => drCloseFollowupModal());
    document.addEventListener('click', (e) => {
      if (!drEls.menuPanel || drEls.menuPanel.hidden) return;
      if (drEls.menuPanel.contains(e.target) || drEls.menuBtn?.contains(e.target)) return;
      drToggleMenu(false);
    });

    document.getElementById('mode').addEventListener('change', () => {
      if (document.getElementById('autoSearch').checked && unifiedModeState.active === 'text') doSearch();
    });
    document.getElementById('topk').addEventListener('change', () => {
      if (document.getElementById('autoSearch').checked && unifiedModeState.active === 'text') doSearch();
    });

    document.getElementById('settingsBtn').addEventListener('click', () => {
      const p = document.getElementById('settingsPanel');
      const b = document.getElementById('settingsBtn');
      const nowHidden = !p.hidden;
      p.hidden = nowHidden;
      b.setAttribute('aria-expanded', String(!nowHidden));
    });

    async function loadProviders() {
      try {
        const p = await api('/api/providers');
        const sel = document.getElementById('provider');
        if (sel && p && Array.isArray(p.supported)) {
          const keep = sel.value;
          sel.innerHTML = '';
          const opt0 = document.createElement('option'); opt0.value = ''; opt0.textContent = 'Default'; sel.appendChild(opt0);
          for (const v of p.supported) { const o = document.createElement('option'); o.value = v; o.textContent = v.toUpperCase(); sel.appendChild(o); }
          const preferred = 'bedrock';
          sel.value = keep || (p.supported.includes(preferred) ? preferred : '');
        }
      } catch {}
    }

    async function loadSearchConfig() {
      try {
        const cfg = await api('/api/search-config');
        const be = document.getElementById('cfgBackend'); if (be) be.textContent = cfg.backend || '-';
        const t = document.getElementById('cfgTopK'); if (t) t.value = cfg.default_top_k != null ? String(cfg.default_top_k) : '';
        const tk = document.getElementById('topk'); if (tk && cfg.default_top_k != null) tk.value = String(cfg.default_top_k);
        const pgRow = document.getElementById('cfgPgvectorRow');
        const osRow = document.getElementById('cfgNumCandRow');
        const pgv = document.getElementById('cfgProbes');
        const ncd = document.getElementById('cfgNumCand');
        if (cfg.backend === 'pgvector') {
          if (pgRow) pgRow.hidden = false; if (osRow) osRow.hidden = true;
          if (pgv) pgv.value = cfg.pgvector_probes != null ? String(cfg.pgvector_probes) : '';
        } else {
          if (pgRow) pgRow.hidden = true;
          const engine = (cfg.opensearch?.engine || 'lucene').toLowerCase();
          if (osRow) osRow.hidden = engine === 'lucene';
          if (ncd) ncd.value = cfg.opensearch?.num_candidates != null ? String(cfg.opensearch.num_candidates) : '';
        }
      } catch (e) {
        // ignore (likely 401 if not logged-in yet)
      }
    }

    async function saveSearchConfig() {
      try {
        const t = document.getElementById('cfgTopK');
        const pgv = document.getElementById('cfgProbes');
        const ncd = document.getElementById('cfgNumCand');
        const body = {};
        if (t && t.value !== '') body.default_top_k = parseInt(t.value, 10);
        if (pgv && !pgv.parentElement.hidden) body.pgvector_probes = pgv.value === '' ? null : parseInt(pgv.value, 10);
        if (ncd && !ncd.parentElement.hidden) body.os_num_candidates = ncd.value === '' ? null : parseInt(ncd.value, 10);
        const resp = await api('/api/search-config', { method: 'POST', body });
        if (resp && resp.ok) { showToast('Saved'); await loadSearchConfig(); }
      } catch (e) {
        showToast('Save failed');
      }
    }

    const loadCfgBtn = document.getElementById('loadCfgBtn');
    if (loadCfgBtn) loadCfgBtn.addEventListener('click', () => loadSearchConfig());
    const saveCfgBtn = document.getElementById('saveCfgBtn');
    if (saveCfgBtn) saveCfgBtn.addEventListener('click', () => saveSearchConfig());

    async function loadDeepResearchConfig() {
      try {
        const cfg = await api('/api/deep-research-config');
        if (cfg && typeof cfg.followup_autosend === 'boolean') {
          drState.followupAutoSend = cfg.followup_autosend;
        }
      } catch (e) {
        // ignore (likely 401 before login)
      }
    }

    // Knowledge Base logic
    async function fetchDocUrl(docId) {
      try {
        const r = await api(`/api/doc-url?doc_id=${encodeURIComponent(docId)}`);
        if (r && r.url) return r.url;
      } catch (e) {}
      return null;
    }

    async function loadKB() {
      try {
        const qsParts = [];
        if (state.spaceId) qsParts.push(`space_id=${encodeURIComponent(state.spaceId)}`);
        if (kbOrder) qsParts.push(`order=${encodeURIComponent(kbOrder)}`);
        if (kbAlphaOrder) qsParts.push(`alpha=${encodeURIComponent(kbAlphaOrder)}`);
        qsParts.push(`limit=${kbPageSize}`);
        qsParts.push(`offset=${(kbPage - 1) * kbPageSize}`);
        const qs = qsParts.length ? `?${qsParts.join('&')}` : '';
        const data = await api(`/api/kb${qs}`);
        const list = document.getElementById('kbList');
        const sec = document.getElementById('kbSection');
        const pagination = document.getElementById('kbPagination');
        const pageInfo = document.getElementById('kbPageInfo');
        const pageList = document.getElementById('kbPageList');
        const total = Number(data.total || 0);
        const totalPages = Math.max(1, Math.ceil(total / kbPageSize));
        if (kbPage > totalPages) kbPage = totalPages;
        list.innerHTML = '';
        if (Array.isArray(data.documents) && data.documents.length) {
          data.documents.forEach((doc) => {
            const div = document.createElement('div');
            div.className = 'kb-doc-item';
            const docTitle = formatDocTitle(doc);
            const link = `<a href="#" data-doc-id="${doc.id}">${escapeHtml(docTitle)}</a>`;
            const metaChips = [];
            if (doc.source_type) metaChips.push(`<span class="badge badge-soft">${escapeHtml(doc.source_type)}</span>`);
            const created = formatDateLabel(doc.created_at);
            if (created) metaChips.push(`<span class="badge badge-soft">${escapeHtml(created)}</span>`);
            if (doc.metadata && doc.metadata.object_url) metaChips.push(renderStorageBadge(state.storageBackend));
            const metaHtml = metaChips.length ? `<div class="kb-doc-meta">${metaChips.join('')}</div>` : '';

            const docImages = Array.isArray(doc.images) ? doc.images : [];
            const downloadHref = doc.id ? `/api/doc-download?doc_id=${doc.id}` : '';
            const previewSrc = docImages.length ? (docImages[0].thumbnail_url || docImages[0].thumbnail_object_url || docImages[0].thumbnail_path || docImages[0].file_path || '') : (doc.thumbnail_preview_url || '');
            const previewBlock = previewSrc ? `<div class="kb-doc-preview"><img src="${escapeHtml(previewSrc)}" alt="Preview for ${escapeHtml(docTitle)}" loading="lazy" /></div>` : '';

            const infoLines = [];
            if (doc.metadata && doc.metadata.summary) infoLines.push(`<li><strong>Summary</strong> ${escapeHtml(doc.metadata.summary)}</li>`);
            if (doc.metadata && doc.metadata.image_caption && !doc.metadata?.summary) {
              infoLines.push(`<li><strong>Caption</strong> ${escapeHtml(doc.metadata.image_caption)}</li>`);
            }
            const infoHtml = infoLines.length ? `<ul class="kb-meta-list">${infoLines.join('')}</ul>` : '<p class="muted">No additional notes yet.</p>';

            const subMetaParts = [];
            if (typeof doc.chunk_count === 'number') subMetaParts.push(`${doc.chunk_count} chunks`);
            if (docImages.length) subMetaParts.push(`${docImages.length} image${docImages.length === 1 ? '' : 's'}`);
            const docTags = normalizeImageTags(doc.metadata?.image_tags || []);
            if (docTags.length) {
              const tags = docTags.map(t => escapeHtml(String(t))).join(', ');
              subMetaParts.push(`Tags: ${tags}`);
            }
            const subMetaHtml = subMetaParts.length ? `<div class="kb-doc-submeta">${subMetaParts.map(part => `<span>${part}</span>`).join('')}</div>` : '';

            const gallery = docImages.map((img) => {
              const thumbSrc = img.thumbnail_url || img.thumbnail_object_url || img.thumbnail_path || img.file_path || '';
              const thumb = thumbSrc ? escapeHtml(thumbSrc) : '';
              const caption = escapeHtml(img.caption || 'No caption');
              const tags = normalizeImageTags(img.tags || []).map(t => `<span class="tag-pill">${escapeHtml(t)}</span>`).join('');
              const remote = (img.object_url || img.thumbnail_object_url) ? renderStorageBadge(state.storageBackend) : '';
              const fileUrl = img.file_url || (doc.id ? `/api/doc-download?doc_id=${doc.id}` : '');
              const downloadLink = fileUrl ? `<a class="ghost" href="${escapeHtml(fileUrl)}" target="_blank" rel="noopener">Open document</a>` : '';
              return `
                <div class="kb-image-card">
                  <div class="kb-image-thumb">${thumb ? `<img src="${thumb}" alt="thumbnail for doc ${doc.id}" loading="lazy" />` : '<div class="thumb-placeholder">No preview</div>'}</div>
                  <div class="kb-image-body">
                    <div class="kb-image-caption">${caption}</div>
                    ${remote ? `<div class="kb-image-meta">${remote}</div>` : ''}
                    <div class="kb-image-tags">${tags || '<span class="muted">No tags</span>'}</div>
                    <div class="kb-image-actions">${downloadLink}</div>
                  </div>
                </div>`;
            }).join('');

            const attachments = docImages.length ? `<details class="kb-attachments"><summary>Images (${docImages.length})</summary><div class="kb-image-grid">${gallery}</div></details>` : '';

            const downloadAction = downloadHref ? `<a class="ghost" href="${escapeHtml(downloadHref)}" target="_blank" rel="noopener">Download</a>` : '';

            div.innerHTML = `
              <div class="kb-doc-card">
                <div class="kb-doc-head">
                  <label class="kb-doc-select">
                    <input type="checkbox" class="kbSel" data-doc-id="${doc.id}" aria-label="Select document" />
                    <span>${link}</span>
                  </label>
                  <div class="kb-doc-actions">
                    ${downloadAction}
                    <button class="ghost" data-delete-doc-id="${doc.id}">Delete</button>
                  </div>
                </div>
                ${metaHtml}
                ${subMetaHtml}
                <div class="kb-doc-body">
                  ${previewBlock}
                  <div class="kb-doc-details">
                    ${infoHtml}
                    ${attachments}
                  </div>
                </div>
              </div>
            `;
            list.appendChild(div);
          });
        } else {
          list.textContent = 'No documents yet.';
        }
        if (pagination) {
          pagination.hidden = totalPages <= 1;
          if (pageInfo) {
            const docLabel = total === 1 ? 'document' : 'documents';
            pageInfo.textContent = `${total} ${docLabel} ‚Ä¢ Page ${kbPage} of ${totalPages}`;
          }
          if (pageList) {
            pageList.innerHTML = '';
            const maxButtons = 5;
            let start = Math.max(1, kbPage - Math.floor(maxButtons / 2));
            let end = Math.min(totalPages, start + maxButtons - 1);
            if (end - start < maxButtons - 1) {
              start = Math.max(1, end - maxButtons + 1);
            }
            const addBtn = (page) => {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'ghost kb-page-btn' + (page === kbPage ? ' active' : '');
              btn.textContent = String(page);
              btn.addEventListener('click', () => {
                kbPage = page;
                loadKB();
              });
              pageList.appendChild(btn);
            };
            if (start > 1) {
              addBtn(1);
              if (start > 2) {
                const ellipsis = document.createElement('span');
                ellipsis.className = 'kb-page-ellipsis';
                ellipsis.textContent = '‚Ä¶';
                pageList.appendChild(ellipsis);
              }
            }
            for (let p = start; p <= end; p += 1) addBtn(p);
            if (end < totalPages) {
              if (end < totalPages - 1) {
                const ellipsis = document.createElement('span');
                ellipsis.className = 'kb-page-ellipsis';
                ellipsis.textContent = '‚Ä¶';
                pageList.appendChild(ellipsis);
              }
              addBtn(totalPages);
            }
          }
        }
        setKbViewMode(kbViewMode);
        sec.hidden = !kbExpanded;
        if (kbExpanded) {
          window.scrollTo({ top: sec.offsetTop - 16, behavior: 'smooth' });
        }
      } catch (e) {
        console.error(e);
        showToast('Failed to load knowledge base');
      }
    }

    document.addEventListener('click', async (e) => {
      const a = e.target.closest('a[data-doc-id]');
      if (a) {
        e.preventDefault();
        const docId = a.getAttribute('data-doc-id');
        window.open(`/api/doc-download?doc_id=${encodeURIComponent(docId)}`, '_blank');
      }
    });

    const kbRefreshBtn = document.getElementById('kbRefreshBtn');
    if (kbRefreshBtn) kbRefreshBtn.addEventListener('click', () => loadKB());

    const kbSortBtn = document.getElementById('kbSortBtn');
    if (kbSortBtn) kbSortBtn.addEventListener('click', () => {
      kbOrder = (kbOrder === 'desc') ? 'asc' : 'desc';
      kbSortBtn.textContent = kbOrder === 'desc' ? 'Latest first' : 'Oldest first';
      kbPage = 1;
      loadKB();
    });

    const kbAlphaSortBtn = document.getElementById('kbAlphaSortBtn');
    if (kbAlphaSortBtn) kbAlphaSortBtn.addEventListener('click', () => {
      if (!kbAlphaOrder) {
        kbAlphaOrder = 'asc';
      } else if (kbAlphaOrder === 'asc') {
        kbAlphaOrder = 'desc';
      } else {
        kbAlphaOrder = null;
      }
      kbAlphaSortBtn.textContent = kbAlphaOrder === 'asc' ? 'A‚ÄìZ' : (kbAlphaOrder === 'desc' ? 'Z‚ÄìA' : 'A‚ÄìZ');
      kbAlphaSortBtn.classList.toggle('active', Boolean(kbAlphaOrder));
      kbPage = 1;
      loadKB();
    });



    const kbViewListBtn = document.getElementById('kbViewListBtn');
    const kbViewGridBtn = document.getElementById('kbViewGridBtn');
    kbViewListBtn?.addEventListener('click', () => setKbViewMode('list'));
    kbViewGridBtn?.addEventListener('click', () => setKbViewMode('grid'));

    const kbHeaderToggle = document.getElementById('kbHeaderToggle');
    kbHeaderToggle?.addEventListener('click', () => {
      setKbExpanded(!kbExpanded);
      if (kbExpanded) {
        kbPage = 1;
        loadKB();
      }
    });

    const uploadHeaderToggle = document.getElementById('uploadHeaderToggle');
    uploadHeaderToggle?.addEventListener('click', () => {
      setUploadExpanded(!uploadExpanded);
    });

    const accountHeaderToggle = document.getElementById('accountHeaderToggle');
    accountHeaderToggle?.addEventListener('click', () => {
      setAccountExpanded(!accountExpanded);
    });

    const researchHeaderToggle = document.getElementById('researchHeaderToggle');
    researchHeaderToggle?.addEventListener('click', () => {
      setResearchExpanded(!researchExpanded);
    });

    document.getElementById('logoHomeBtn')?.addEventListener('click', () => {
      resetHomeView().catch(console.error);
    });
    document.getElementById('topbarHomeBtn')?.addEventListener('click', () => {
      resetHomeView().catch(console.error);
    });

    // KB delete single
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-delete-doc-id]');
      if (btn) {
        e.preventDefault();
        const id = btn.getAttribute('data-delete-doc-id');
        const ok = confirm('Are you sure you want to delete this file?');
        if (!ok) return;
        try {
          const res = await fetch(`/api/admin/documents/${encodeURIComponent(id)}`, { method: 'DELETE' });
          if (res.ok) { showToast('Deleted'); await loadKB(); } else { showToast('Delete failed'); }
        } catch { showToast('Delete failed'); }
      }
    });

    // KB bulk select/delete
    const kbSelectAll = document.getElementById('kbSelectAll');
    if (kbSelectAll) kbSelectAll.addEventListener('change', () => {
      const boxes = document.querySelectorAll('input.kbSel');
      boxes.forEach(b => { b.checked = kbSelectAll.checked; });
    });
    const kbDeleteSelectedBtn = document.getElementById('kbDeleteSelectedBtn');
    if (kbDeleteSelectedBtn) kbDeleteSelectedBtn.addEventListener('click', async () => {
      const boxes = Array.from(document.querySelectorAll('input.kbSel:checked'));
      if (!boxes.length) { showToast('No selection'); return; }
      const ok = confirm(`Are you sure you want to delete ${boxes.length} file(s)?`);
      if (!ok) return;
      for (const b of boxes) {
        const id = b.getAttribute('data-doc-id');
        try { await fetch(`/api/admin/documents/${encodeURIComponent(id)}`, { method: 'DELETE' }); } catch {}
      }
      showToast('Delete requested');
      await loadKB();
    });

    // Drag-and-drop support
    const dropzone = document.getElementById('dropzone');
    const dzStatus = document.getElementById('dzStatus');
    let droppedFiles = [];

    let ALLOWED_EXTS = new Set([".pdf",".txt",".csv",".md",".json",".html",".htm",".docx",".pptx",".xlsx",".png",".jpg",".jpeg",".tif",".tiff",".bmp",".gif"]);
    let SUPPORTED_TYPES_TXT = 'PDF, DOCX, PPTX, XLSX, TXT, HTML, CSV, MD, JSON, PNG, JPG, JPEG, TIFF, BMP, GIF';
    let MAX_FILES = 100;
    let MAX_BYTES = 50 * 1024 * 1024; // 50MB

    async function loadUploadConfig() {
      try {
        const cfg = await api('/api/upload-config');
        if (cfg && typeof cfg === 'object') {
          state.storageBackend = cfg.storage_backend || null;
          if (Array.isArray(cfg.allowed_extensions) && cfg.allowed_extensions.length) {
            ALLOWED_EXTS = new Set(cfg.allowed_extensions.map(e => String(e).toLowerCase()));
            const list = Array.from(ALLOWED_EXTS).map(e => e.replace(/^\./, '').toUpperCase());
            SUPPORTED_TYPES_TXT = list.join(', ');
          }
          if (cfg.max_upload_files != null) {
            MAX_FILES = parseInt(cfg.max_upload_files, 10) || MAX_FILES;
          }
          if (cfg.max_upload_size_mb != null) {
            MAX_BYTES = (parseInt(cfg.max_upload_size_mb, 10) || 50) * 1024 * 1024;
          }
          const info = document.getElementById('uploadStorageInfo');
          if (info) {
            info.innerHTML = '';
            info.hidden = true;
          }
        }
      } catch (e) {
        // ignore, keep defaults
      }
    }

    function addFilesToList(fileList, opts = { isFolder: false }) {
      const added = [];
      const skipped = [];
      let skippedType = 0;
      let skippedSize = 0;
      for (const f of fileList) {
        if (droppedFiles.length + added.length >= MAX_FILES) { skipped.push(`${f.name} (limit reached)`); continue; }
        const ext = ('.' + (f.name.split('.').pop() || '')).toLowerCase();
        if (!ALLOWED_EXTS.has(ext)) { skipped.push(`${f.name} (type)`); skippedType++; continue; }
        if (f.size > MAX_BYTES) { skipped.push(`${f.name} (size)`); skippedSize++; continue; }
        added.push(f);
      }
      droppedFiles.push(...added);
      if (dzStatus) dzStatus.textContent = droppedFiles.length ? `${droppedFiles.length} file(s) ready` : 'Drop files here or use the file chooser above';
      if (opts.isFolder && (skippedType > 0 || (fileList.length + (droppedFiles.length - added.length)) > MAX_FILES)) {
        showToast(`Folder contains unsupported types or too many files. Please upload a folder with 100 files or less and only supported types: ${SUPPORTED_TYPES_TXT}.`);
      } else if (skipped.length) {
        showToast(`Some files skipped: ${skipped.slice(0,3).join(', ')}${skipped.length>3?'‚Ä¶':''}`);
      } else {
        showToast(`${droppedFiles.length} file(s) ready`);
      }
    }

    async function traverseEntry(entry) {
      return new Promise((resolve) => {
        if (entry.isFile) {
          entry.file(file => resolve([file]));
        } else if (entry.isDirectory) {
          const reader = entry.createReader();
          const out = [];
          const read = () => reader.readEntries(async entries => {
            if (!entries.length) return resolve(out);
            for (const e of entries) {
              const nested = await traverseEntry(e);
              out.push(...nested);
            }
            read();
          });
          read();
        } else {
          resolve([]);
        }
      });
    }

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
    dropzone.addEventListener('drop', async (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const items = e.dataTransfer.items;
      let isFolder = false;
      if (items && items.length && items[0].webkitGetAsEntry) {
        let all = [];
        for (const it of items) {
          const entry = it.webkitGetAsEntry();
          if (entry) {
            if (entry.isDirectory) isFolder = true;
            const files = await traverseEntry(entry);
            all.push(...files);
          }
        }
        addFilesToList(all, { isFolder });
      } else {
        addFilesToList(e.dataTransfer.files, { isFolder: false });
      }
    });

    const filesInputEl = document.getElementById('files');
    if (filesInputEl) {
      filesInputEl.addEventListener('change', () => {
        const count = filesInputEl.files ? filesInputEl.files.length : 0;
        const badge = document.getElementById('fileSelectionText');
        if (badge) badge.textContent = count ? `${count} file(s) selected.` : 'No files selected.';
        if (dzStatus) dzStatus.textContent = count ? `${count} file(s) selected` : 'Drop files here or use the file chooser above';
      });
    }

    // Upload with per-file progress and space_id
    const clearBtn = document.getElementById('clearUploadBtn');
    if (clearBtn) clearBtn.addEventListener('click', () => {
      try {
        const files = document.getElementById('files');
        const status = document.getElementById('uploadStatus');
        const list = document.getElementById('uploadList');
        const listRow = document.getElementById('uploadListRow');
        const statusRow = document.getElementById('uploadStatusRow');
        const badge = document.getElementById('fileSelectionText');
        if (files) files.value = '';
        if (status) status.textContent = '';
        if (list) list.innerHTML = '';
        if (listRow) listRow.hidden = true;
        if (statusRow) statusRow.hidden = true;
        droppedFiles = [];
        if (dzStatus) dzStatus.textContent = 'Drop files here or use the file chooser above';
        if (badge) badge.textContent = 'No files selected.';
        showToast('Cleared');
      } catch {}
    });

    document.getElementById('uploadBtn').addEventListener('click', async () => {
      if (!state.user) { showToast('Login required'); return; }
      const filesInput = document.getElementById('files');
      const status = document.getElementById('uploadStatus');
      const statusRow = document.getElementById('uploadStatusRow');
      const loading = document.getElementById('uploadLoading');
      const list = document.getElementById('uploadList');
      const listRow = document.getElementById('uploadListRow');
      const embeddingBadge = document.getElementById('uploadEmbeddingStatus');
      status.textContent = '';
      if (embeddingBadge) {
        embeddingBadge.hidden = true;
        embeddingBadge.textContent = '';
      }

      const selA = filesInput?.files ? Array.from(filesInput.files) : [];
      let allFiles = [...selA, ...droppedFiles];
      if (!allFiles.length) { showToast('No files selected'); return; }
      // Filter client-side as well
      const filtered = [];
      for (const f of allFiles) {
        const ext = ('.' + (f.name.split('.').pop() || '')).toLowerCase();
        if (!ALLOWED_EXTS.has(ext)) continue;
        if (f.size > MAX_BYTES) continue;
        filtered.push(f);
        if (filtered.length >= MAX_FILES) break;
      }
      allFiles = filtered;
      if (!allFiles.length) { showToast('No valid files to upload'); return; }

      list.innerHTML = '';
      listRow.hidden = false;
      statusRow.hidden = false;
      const entries = new Map();
      for (const f of allFiles) {
        const item = document.createElement('div');
        item.className = 'progress-item';
        item.innerHTML = `
          <div class="progress-row"><span>${escapeHtml(f.webkitRelativePath || f.name)}</span><span class="pct">0%</span></div>
          <div class="progress"><div class="progress-bar"></div></div>
        `;
        list.appendChild(item);
        entries.set(f, item);
      }

      loading.hidden = false;

      const maxRetries = 3;
      const backoff = (attempt) => Math.min(2000, 300 * Math.pow(2, attempt - 1));

      function uploadOne(file, attempt = 1) {
        return new Promise((resolve) => {
          const item = entries.get(file);
          const bar = item.querySelector('.progress-bar');
          const pctLabel = item.querySelector('.pct');
          const xhr = new XMLHttpRequest();
          xhr.open('POST', '/api/upload');

          xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
              const pct = Math.round((e.loaded / e.total) * 100);
              bar.style.width = pct + '%';
              pctLabel.textContent = pct + '%';
            } else {
              bar.style.width = '50%';
              pctLabel.textContent = '‚Ä¶';
            }
          };
          xhr.upload.onload = () => { pctLabel.textContent = 'processing‚Ä¶'; };

          xhr.onerror = () => {
            if (attempt < maxRetries) {
              const delay = backoff(attempt);
              pctLabel.textContent = `retrying (${attempt}/${maxRetries})‚Ä¶`;
              setTimeout(() => resolve(uploadOne(file, attempt + 1)), delay);
            } else { pctLabel.textContent = 'failed'; resolve({ file, ok: false, error: 'network error' }); }
          };

          xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
              if (xhr.status >= 200 && xhr.status < 300) {
                try {
                  const data = JSON.parse(xhr.responseText);
                  bar.style.width = '100%';
                  pctLabel.textContent = '100%';
                  try {
                    const res = Array.isArray(data.results) ? data.results[0] : data;
                    if (res && typeof res === 'object') {
                      const docId = res.document_id || res.documentId;
                      const chunks = res.chunks || res.num_chunks;
                      const msg = [];
                      if (chunks != null) msg.push(`${chunks} chunks`);
                      const row = item.querySelector('.progress-row span');
                      if (row && msg.length) row.textContent = `${row.textContent} ‚Äî processed (${msg.join(', ')})`;
                      const isImageFile = /\.(png|jpe?g|tiff?|bmp|gif|webp)$/i.test(file.name || '');
                      if (docId != null && embeddingBadge && isImageFile) {
                        checkImageEmbeddingStatus(docId).then((diag) => {
                          if (diag && diag.postgres) {
                            const ok = diag.postgres.embedding === true;
                            if (!ok) {
                              embeddingBadge.hidden = false;
                              embeddingBadge.textContent = 'Image embedding missing';
                              embeddingBadge.classList.remove('badge-soft');
                              embeddingBadge.classList.add('badge-warn');
                              return;
                            }
                            embeddingBadge.hidden = false;
                            embeddingBadge.textContent = 'Image embedding stored';
                            embeddingBadge.classList.add('badge-soft');
                            embeddingBadge.classList.remove('badge-warn');
                          }
                        });
                      }
                    }
                  } catch {}
                  resolve({ file, ok: true, data });
                } catch (e) {
                  if (attempt < maxRetries) {
                    const delay = backoff(attempt);
                    pctLabel.textContent = `retrying (${attempt}/${maxRetries})‚Ä¶`;
                    setTimeout(() => resolve(uploadOne(file, attempt + 1)), delay);
                  } else { pctLabel.textContent = 'failed'; resolve({ file, ok: false, error: 'parse error' }); }
                }
              } else if (xhr.status >= 500 && attempt < maxRetries) {
                const delay = backoff(attempt);
                pctLabel.textContent = `retrying (${attempt}/${maxRetries})‚Ä¶`;
                setTimeout(() => resolve(uploadOne(file, attempt + 1)), delay);
              } else {
                pctLabel.textContent = 'failed';
                resolve({ file, ok: false, error: xhr.responseText || `HTTP ${xhr.status}` });
              }
            }
          };

          const form = new FormData();
          form.append('files', file);
          if (state.spaceId) form.append('space_id', String(state.spaceId));
          xhr.send(form);
        });
      }

      const queue = [...allFiles];
      const inFlight = new Set();
      const results = [];

      async function pump() {
        while (inFlight.size < 4 && queue.length) {
          const f = queue.shift();
          const p = uploadOne(f).then((res) => {
            inFlight.delete(p);
            results.push(res);
            pump();
          });
          inFlight.add(p);
        }
        if (!queue.length && !inFlight.size) {
          loading.hidden = true;
          try {
            const items = results.map(r => {
              const name = r.file.webkitRelativePath || r.file.name;
              const icon = r.ok ? '‚úÖ' : '‚ùå';
              const err = r.error ? ` ‚Äî ${String(r.error)}` : '';
              return `<div>${icon} ${escapeHtml(name)}${err}</div>`;
            }).join('');
            status.innerHTML = items || 'Upload finished';
            showToast('Upload finished');
          } catch (e) {
            status.textContent = 'Upload finished';
          }
          droppedFiles = [];
          try { await loadKB(); } catch {}
        }
      }

      pump();
    });

    window.addEventListener('DOMContentLoaded', async () => {
      const files = document.getElementById('files');
      const status = document.getElementById('uploadStatus');
      const badge = document.getElementById('fileSelectionText');
      if (searchInputEl) searchInputEl.value = '';
      if (files) files.value = '';
      if (status) status.textContent = '';
      if (dzStatus) dzStatus.textContent = 'Drop files here or use the file chooser above';
      if (badge) badge.textContent = 'No files selected.';
      droppedFiles = [];
      setTopbarSpaceVisible(false);
      setKbExpanded(false);
      setUploadExpanded(false);
      setAccountExpanded(false);
      setResearchExpanded(false);
      setKbViewMode('list');
      await initUser();
      await loadProviders();
      await loadSearchConfig();
      await loadDeepResearchConfig();
      await loadUploadConfig();
      if (state && state.user) { try { await loadKB(); } catch (e) {} }
      setActiveScreen('search');
    });

    window.addEventListener('beforeunload', () => {
      if (drState.open) drAutoSaveSessionTitle();
    });
  </script>
</body>
</html>